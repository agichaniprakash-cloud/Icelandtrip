<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pending Payments â€” Live from Google Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#138a5a;
    --muted:#6b7280;
    --card:#ffffff;
    --bg:#f6f8f9;
    --radius:12px;
  }
  html,body{height:100%}
  body{
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    margin:0;
    background:var(--bg);
    color:#111827;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:28px;
  }

  .wrap{max-width:980px;margin:0 auto}
  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:20px 28px;
    box-shadow:0 4px 18px rgba(16,24,40,0.06);
  }

  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  header h1{font-size:28px;margin:0}
  header p{margin:0;color:var(--muted);font-size:14px}

  .controls{display:flex;flex-wrap:wrap;gap:10px;margin:16px 0}
  .controls input[type="search"]{
    flex:1 1 320px;padding:12px 14px;border-radius:10px;border:1px solid #e6e9ee;
    outline:none;font-size:14px;
  }
  .btn{
    background:var(--accent);color:white;padding:10px 16px;border-radius:9px;border:none;
    cursor:pointer;font-weight:600;box-shadow:none;
  }
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ee}
  .btn.small{padding:8px 12px;font-size:14px}

  .row{display:flex;gap:12px;align-items:center}
  .select, .input{
    padding:10px;border-radius:10px;border:1px solid #e6e9ee;background:white;
    min-width:140px;
  }

  table{width:100%;border-collapse:collapse;margin-top:18px}
  thead th{
    text-align:left;padding:16px;background:var(--accent);color:white;font-weight:700;font-size:15px;
    border-top-left-radius:8px;border-top-right-radius:8px;
  }
  tbody tr{background:#fbfcfd}
  td{padding:16px;border-bottom:1px solid #eef2f6;vertical-align:middle}
  tbody tr:nth-child(even){background:#ffffff}
  .empty{color:var(--muted);text-align:center;padding:28px}

  form .field{margin-top:12px}
  form input, form textarea, form select{
    width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9ee;font-size:15px;
  }
  form .two{display:flex;gap:12px}
  form .two > *{flex:1}

  .tip{color:var(--muted);font-size:13px;margin-top:14px}
  .notice{margin-top:12px;font-size:14px;color:var(--muted)}

  @media (max-width:700px){
    header{flex-direction:column;align-items:flex-start}
    .controls{flex-direction:column}
    thead th{font-size:13px;padding:12px}
    td{padding:12px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div style="font-size:30px">ðŸ“‹</div>
      <div>
        <h1>Pending Payments</h1>
        <p>Live from Google Sheet (via SheetDB)</p>
      </div>
    </header>

    <!-- controls -->
    <div class="controls">
      <input id="search" type="search" placeholder="Search client, mobile or remark" aria-label="Search">
      <div class="row">
        <select id="refreshInterval" class="select" title="Auto refresh interval">
          <option value="0">Auto refresh: Off</option>
          <option value="15">Refresh every 15s</option>
          <option value="30">Refresh every 30s</option>
          <option value="60" selected>Refresh every 60s</option>
          <option value="300">Refresh every 5m</option>
        </select>
        <button id="pendingOnlyBtn" class="btn small">Show: Pending only</button>
        <button id="reload" class="btn small">Reload now</button>
      </div>
    </div>

    <!-- table -->
    <div id="tableWrap">
      <table id="dataTable" role="table" aria-label="Pending payments table">
        <thead>
          <tr>
            <th>Client Name</th>
            <th>Mobile</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Status</th>
            <th>Remark</th>
            <th>Days Pending</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="empty" colspan="7">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <hr style="margin:22px 0;border:0;border-top:1px solid #eef2f6">

    <h2 style="margin:0 0 8px 0">Add New Pending Client</h2>

    <form id="addForm">
      <div class="field">
        <input id="clientname" name="clientname" placeholder="Client Name" autocomplete="off">
      </div>

      <div class="field">
        <input id="mobile" name="mobile" placeholder="Mobile" autocomplete="off">
      </div>

      <div class="field">
        <input id="amount" name="amount" placeholder="Amount" autocomplete="off">
      </div>

      <div class="field">
        <input id="date" name="date" placeholder="Date (e.g. 10/1/2025)" autocomplete="off">
      </div>

      <div class="field">
        <select id="status" name="status">
          <option value="pending" selected>Pending</option>
          <option value="paid">Paid</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="field">
        <input id="remark" name="remark" placeholder="Remark" autocomplete="off">
      </div>

      <div style="margin-top:12px">
        <button id="addBtn" class="btn" type="submit">Add</button>
        <span id="formMsg" style="margin-left:12px;color:var(--muted)"></span>
      </div>

      <div class="tip">Tip: Editing the Google Sheet directly (published as CSV) will also update this site when refreshed.</div>
    </form>

  </div>
</div>

<script>
/*
  Final HTML (client side) for SheetDB API
  Replace API_URL if you rebuild the API.
*/
const API_URL = 'https://sheetdb.io/api/v1/zla8gcygz4jgd'; // <<-- your SheetDB endpoint

// Column keys used in the sheet (must match exactly)
const KEYS = ['clientname','mobile','amount','date','status','remark','days_pending'];

// DOM
const tbody = document.getElementById('tbody');
const searchInput = document.getElementById('search');
const reloadBtn = document.getElementById('reload');
const pendingOnlyBtn = document.getElementById('pendingOnlyBtn');
const refreshInterval = document.getElementById('refreshInterval');
const addForm = document.getElementById('addForm');
const formMsg = document.getElementById('formMsg');

let allData = [];
let showPendingOnly = true;
let autoTimer = null;

// helpers
function safe(value){ return value == null ? '' : String(value); }
function fmtDate(s){
  if(!s) return '';
  // prefer showing as entered; optionally parse
  return s;
}
function daysDiffFromToday(dateStr){
  if(!dateStr) return '';
  // try to parse dd/mm/yyyy or mm/dd/yyyy heuristically
  // We'll attempt Date parsing; user-entered format might be 10/1/2025
  let d = new Date(dateStr);
  if(isNaN(d)){
    // try converting slash-separated tokens (fallback)
    let parts = dateStr.split(/[\/\-\.]/).map(t=>t.trim());
    if(parts.length>=3){
      // try mm/dd/yyyy then dd/mm/yyyy fallback
      let mm = parseInt(parts[0],10), dd = parseInt(parts[1],10), yyyy = parseInt(parts[2],10);
      // heuristics: if mm>12 swap
      if(mm>12){ let tmp=mm; mm=dd; dd=tmp; }
      d = new Date(yyyy, mm-1, dd);
    }
  }
  if(isNaN(d)) return '';
  const today = new Date();
  // zero out hours for stable count
  const diff = Math.floor((today - new Date(d.getFullYear(),d.getMonth(),d.getDate())) / (1000*60*60*24));
  return diff >= 0 ? String(diff) : '';
}

function buildRow(obj){
  // ensure keys exist
  const row = {};
  KEYS.forEach(k => row[k] = safe(obj[k] || ''));
  // ensure days_pending computed if missing or keep provided
  if(!row.days_pending){
    row.days_pending = daysDiffFromToday(row.date);
  }
  return row;
}

function renderTable(data){
  allData = data.map(buildRow);

  applyAndRender();
}

function applyAndRender(){
  const q = (searchInput.value || '').trim().toLowerCase();
  let rows = allData.slice();
  if(showPendingOnly){
    rows = rows.filter(r => (r.status || '').toLowerCase() === 'pending');
  }
  if(q){
    rows = rows.filter(r => {
      return KEYS.some(k => (r[k]||'').toString().toLowerCase().includes(q));
    });
  }

  // render
  if(rows.length === 0){
    tbody.innerHTML = '<tr><td class="empty" colspan="7">No records</td></tr>';
    return;
  }
  const html = rows.map(r => {
    return `<tr>
      <td>${escapeHtml(r.clientname)}</td>
      <td>${escapeHtml(r.mobile)}</td>
      <td>${escapeHtml(r.amount)}</td>
      <td>${escapeHtml(fmtDate(r.date))}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.remark)}</td>
      <td style="text-align:center">${escapeHtml(r.days_pending)}</td>
    </tr>`;
  }).join('');
  tbody.innerHTML = html;
}

function escapeHtml(s){
  return (s+'').replace(/[&<>"']/g, c =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// fetch data
async function fetchData(){
  try{
    tbody.innerHTML = '<tr><td class="empty" colspan="7">Loadingâ€¦</td></tr>';
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error('Network response not OK');
    const json = await res.json();
    // SheetDB returns array
    renderTable(json || []);
  }catch(err){
    tbody.innerHTML = `<tr><td class="empty" colspan="7">Error loading data â€” ${escapeHtml(err.message || err)}</td></tr>`;
    console.error(err);
  }
}

// add row POST
async function addRow(formData){
  // build data object with keys exactly as sheet header
  const obj = {
    clientname: (formData.get('clientname')||'').trim(),
    mobile: (formData.get('mobile')||'').trim(),
    amount: (formData.get('amount')||'').trim(),
    date: (formData.get('date')||'').trim(),
    status: (formData.get('status')||'').trim() || 'pending',
    remark: (formData.get('remark')||'').trim()
  };
  // compute days_pending
  obj.days_pending = daysDiffFromToday(obj.date);

  try{
    formMsg.textContent = 'Sendingâ€¦';
    addBtnDisabled(true);

    const payload = { data: [obj] };
    const r = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){
      // try to read text message
      const txt = await r.text();
      throw new Error('Failed to add: '+ (txt||r.statusText));
    }
    // success â€” reload table
    formMsg.textContent = 'Added âœ“';
    setTimeout(()=>formMsg.textContent='', 2400);
    await fetchData();
    addForm.reset();
  }catch(err){
    formMsg.textContent = 'Error: '+ (err.message || err);
    console.error(err);
  } finally {
    addBtnDisabled(false);
  }
}

function addBtnDisabled(flag){
  const btn = document.getElementById('addBtn');
  if(btn) btn.disabled = !!flag;
}

// events
searchInput.addEventListener('input', ()=>applyAndRender());
reloadBtn.addEventListener('click', fetchData);
pendingOnlyBtn.addEventListener('click', ()=>{
  showPendingOnly = !showPendingOnly;
  pendingOnlyBtn.textContent = showPendingOnly ? 'Show: Pending only' : 'Show: All';
  applyAndRender();
});

addForm.addEventListener('submit', (ev)=>{
  ev.preventDefault();
  const fd = new FormData(addForm);

  // minimal validation
  if(!fd.get('clientname') || !fd.get('status')){
    formMsg.textContent = 'Please add client name and status';
    return;
  }
  addRow(fd);
});

// auto refresh control
refreshInterval.addEventListener('change', ()=>{
  const val = Number(refreshInterval.value || 0);
  if(autoTimer) { clearInterval(autoTimer); autoTimer=null; }
  if(val>0){
    autoTimer = setInterval(fetchData, val*1000);
  }
});

// initial load
fetchData();

// expose for console (debug)
window._sheetdb = { fetchData, allData };
</script>
</body>
</html>
