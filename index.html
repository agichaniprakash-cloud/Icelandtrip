<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pending Payments — Perfect Digital Network</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --green:#138a55;
    --accent:#e67e22;
    --muted:#6b6f72;
    --card:#ffffff;
    --bg:#f6f7f8;
    --radius:10px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#1f2933;padding:20px;}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  header h1{margin:0;font-size:28px}
  .brand { display:flex; align-items:center; gap:12px; }
  .brand .logo { width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#ecf9f1,#e9f5ef); display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green); }
  .card{background:var(--card);padding:22px;border-radius:var(--radius);box-shadow:0 8px 20px rgba(9,20,30,0.06); margin-bottom:18px}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
  .controls input[type=search]{width:100%;max-width:640px;padding:12px;border-radius:8px;border:1px solid #e6e9ea}
  .btn{background:var(--green);color:white;padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
  .btn.ghost{background:#fff;border:1px solid #e6e9ea;color:var(--muted)}
  .tableWrap{overflow-x:auto;margin-top:12px}
  table{border-collapse:collapse;width:100%;min-width:860px}
  thead th{background:var(--green);color:#fff;padding:14px 12px;text-align:left}
  tbody td{padding:12px 10px;border-bottom:1px solid #f1f2f3;vertical-align:middle}
  tbody tr:nth-child(even) td{background:#fafafa}
  .actionBtn{border-radius:8px;border:1px solid #e6e9ea;padding:6px 10px;background:#fff;color:var(--muted);cursor:pointer}
  .waBtn{background:var(--green);color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;}
  .formRow{display:flex;flex-direction:column;gap:10px;margin-top:20px}
  .formRow input,.formRow select, .formRow textarea{padding:12px;border-radius:8px;border:1px solid #e6e9ea}
  .formRow .row{display:flex;gap:10px}
  .formRow .row input{flex:1}
  .notice{font-size:13px;color:var(--muted);margin-top:12px}
  .small { font-size:13px;color:var(--muted) }
  .stats{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  .stat{background:#f0fbf6;border:1px solid #e9f5ef;padding:12px;border-radius:8px;min-width:150px}
  .pager{display:flex;gap:8px;align-items:center;margin-top:12px}
  .smallSelect{padding:8px;border-radius:8px;border:1px solid #e6e9ea;background:#fff}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="brand">
      <div class="logo">PDN</div>
      <div>
        <h1>PERFECT DIGITAL NETWORK</h1>
        <div style="color:var(--muted);font-size:14px">Pending payments dashboard (Live)</div>
      </div>
    </div>
    <div style="margin-left:auto;text-align:right;color:var(--muted);font-size:13px">
      UPI ID: <strong>perfectdigital@axl</strong>
    </div>
  </header>

  <div class="card">
    <div class="controls">
      <input id="searchBox" type="search" placeholder="Search client, mobile or address" />
      <select id="refreshSel" class="smallSelect" title="Auto refresh">
        <option value="0">No Auto-refresh</option>
        <option value="15">Every 15s</option>
        <option value="30">Every 30s</option>
        <option value="60" selected>Every 60s</option>
      </select>
      <button id="pendingToggle" class="btn ghost">Pending only</button>
      <button id="reloadBtn" class="btn">Reload now</button>
    </div>

    <div class="stats">
      <div class="stat"><div class="small">Total clients:</div><div id="statTotal">—</div></div>
      <div class="stat"><div class="small">Pending count:</div><div id="statPending">—</div></div>
      <div class="stat"><div class="small">Pending amount:</div><div id="statPendingAmt">—</div></div>
    </div>

    <div class="tableWrap" id="tableWrap">
      <table id="dataTable" role="table">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="pager">
      <label>Show per page:</label>
      <select id="perPage" class="smallSelect"><option>10</option><option selected>20</option><option>50</option></select>
      <div style="margin-left:auto">
        <button id="prevPage" class="actionBtn">Prev</button>
        <button id="nextPage" class="actionBtn">Next</button>
        <span id="pageInfo" class="small">Page 1</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Add new client</h2>
    <div class="formRow">
      <div class="row">
        <input id="f_name" placeholder="Client name" />
        <input id="f_mobile" placeholder="Mobile (10 digits or with country code)" />
      </div>
      <div class="row">
        <input id="f_amount" placeholder="Amount (₹)" />
        <input id="f_date" placeholder="Date DD/MM/YYYY" />
      </div>
      <div class="row">
        <select id="f_status"><option>pending</option><option>paid</option></select>
        <select id="f_address">
          <option value="">-- choose address --</option>
          <option>Wazirpur</option><option>Shas/Trinagar</option>
          <option>Ashok Vihar</option><option>Gulabi Bagh</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <button id="addBtn" class="btn">Add client</button>
        <div id="msg" style="color:var(--muted)"></div>
      </div>
    </div>
  </div>

</div>

<script>
const SHEETDB_API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd';
const QR_IMAGE_URL = 'https://agichaniprakash-cloud.github.io/PerfectDigital/Screenshot_20251005_074910_PhonePe.jpg';
const UPI_ID = 'perfectdigital@axl';

const canonical = ["clientname","mobile","amount","date","status","address"];
let headerMap={},lastData=[],filterPending=false,currentPage=1,perPage=20,refreshTimer=null;

function norm(s){return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[_\-]+/g,'').replace(/[^a-z0-9]/g,'');}
function normalizePhone(m){if(!m)return'';let d=String(m).replace(/\D/g,'').replace(/^0+/,'');if(d.length===10)d='91'+d;return d;}
function buildWhatsAppText(r){const n=r[headerMap.clientname]||'',a=r[headerMap.amount]||'';return`Hello ${n},\n\nYour broadband payment of ₹${a} is pending.\n\nPlease pay via UPI ID: ${UPI_ID}\nIf you've already paid, please ignore.\n\nUPI QR — *CLICK ON THE LINK TO OPEN:*\n${QR_IMAGE_URL}`;}

async function fetchData(){
 try{const res=await fetch(SHEETDB_API);const data=await res.json();lastData=data;detectHeaders(data);renderTable();updateStats();}
 catch(e){console.error(e);}
}

function detectHeaders(data){
 headerMap={};if(data.length){const keys=Object.keys(data[0]),lk={};keys.forEach(k=>lk[norm(k)]=k);
 const v={clientname:['clientname','client','name'],mobile:['mobile','phone'],amount:['amount','amt'],date:['date'],status:['status'],address:['address','area']};
 canonical.forEach(c=>{let f=null;for(const x of(v[c]||[c]))if(lk[norm(x)]){f=lk[norm(x)];break;}if(!f&&lk[norm(c)])f=lk[norm(c)];headerMap[c]=f||keys[0];});
 }else canonical.forEach(c=>headerMap[c]=c);
}

function renderTable(){
 const th=document.getElementById('tableHead'),tb=document.getElementById('tableBody');
 th.innerHTML='';tb.innerHTML='';
 const h=document.createElement('tr');
 h.innerHTML=`<th></th><th>Client Name</th><th>Mobile</th><th>Amount</th><th>Date</th><th>Status</th><th>Address</th><th>Actions</th>`;
 th.appendChild(h);

 const s=document.getElementById('searchBox').value.toLowerCase();
 const f=lastData.filter(r=>{
  if(filterPending&&!String(r[headerMap.status]).toLowerCase().includes('pending'))return false;
  if(s&&!Object.values(r).join(' ').toLowerCase().includes(s))return false;
  return true;
 });
 perPage=Number(document.getElementById('perPage').value||20);
 const pages=Math.max(1,Math.ceil(f.length/perPage));if(currentPage>pages)currentPage=pages;
 const page=f.slice((currentPage-1)*perPage,(currentPage-1)*perPage+perPage);

 page.forEach(r=>{
  const tr=document.createElement('tr');
  // WhatsApp first column
  const tdWA=document.createElement('td');
  const wa=document.createElement('button');
  wa.className='waBtn';wa.textContent='Send';
  wa.onclick=()=>{
   const p=normalizePhone(r[headerMap.mobile]),text=buildWhatsAppText(r);
   const url=p.length>=11?`https://wa.me/${p}?text=${encodeURIComponent(text)}`:`https://web.whatsapp.com/send?text=${encodeURIComponent(text)}`;
   window.open(url,'_blank');
  };
  tdWA.appendChild(wa);tr.appendChild(tdWA);

  ['clientname','mobile','amount','date','status','address'].forEach(k=>{
   const td=document.createElement('td');td.textContent=r[headerMap[k]]||'';tr.appendChild(td);
  });

  const tda=document.createElement('td');
  const e=document.createElement('button');
  e.className='actionBtn';e.textContent='Edit';
  e.onclick=()=>{
   document.getElementById('f_name').value=r[headerMap.clientname]||'';
   document.getElementById('f_mobile').value=r[headerMap.mobile]||'';
   document.getElementById('f_amount').value=r[headerMap.amount]||'';
   document.getElementById('f_date').value=r[headerMap.date]||'';
   document.getElementById('f_status').value=r[headerMap.status]||'pending';
   document.getElementById('f_address').value=r[headerMap.address]||'';
   document.getElementById('f_name').scrollIntoView({behavior:'smooth'});
  };
  tda.appendChild(e);tr.appendChild(tda);
  tb.appendChild(tr);
 });
 document.getElementById('pageInfo').textContent=`Page ${currentPage} of ${pages}`;
}

function updateStats(){
 const t=lastData.length;
 const p=lastData.filter(r=>String(r[headerMap.status]).toLowerCase().includes('pending'));
 const c=p.length,a=p.reduce((x,r)=>x+(parseFloat(String(r[headerMap.amount]).replace(/[^\d.]/g,''))||0),0);
 document.getElementById('statTotal').textContent=t;
 document.getElementById('statPending').textContent=c;
 document.getElementById('statPendingAmt').textContent='₹'+a.toFixed(0);
}

document.getElementById('addBtn').onclick=async()=>{
 const n=f_name.value.trim(),m=f_mobile.value.trim(),a=f_amount.value.trim(),d=f_date.value.trim(),s=f_status.value.trim(),ad=f_address.value.trim();
 if(!n&&!m)return alert('Enter name or mobile');
 const obj={};obj[headerMap.clientname||'clientname']=n;obj[headerMap.mobile||'mobile']=m;
 obj[headerMap.amount||'amount']=a;obj[headerMap.date||'date']=d;obj[headerMap.status||'status']=s;obj[headerMap.address||'address']=ad;
 await fetch(SHEETDB_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:[obj]})});
 msg.textContent='Added — reloading...';setTimeout(fetchData,600);
};

document.getElementById('reloadBtn').onclick=fetchData;
document.getElementById('pendingToggle').onclick=e=>{filterPending=!filterPending;e.target.classList.toggle('btn',filterPending);renderTable();};
document.getElementById('nextPage').onclick=()=>{currentPage++;renderTable();};
document.getElementById('prevPage').onclick=()=>{if(currentPage>1)currentPage--;renderTable();};
document.getElementById('perPage').onchange=()=>{currentPage=1;renderTable();};
document.getElementById('searchBox').oninput=()=>{currentPage=1;renderTable();};
document.getElementById('refreshSel').onchange=e=>{const v=+e.target.value;if(refreshTimer)clearInterval(refreshTimer);if(v>0)refreshTimer=setInterval(fetchData,v*1000);};
fetchData();
</script>
</body>
</html>
