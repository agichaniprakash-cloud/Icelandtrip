<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PERFECT DIGITAL NETWORK – Pending Payments (CodeDoneR2)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --green:#138a55;
    --muted:#6b6f72;
    --card:#ffffff;
    --bg:#f6f7f8;
    --radius:10px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#1f2933;padding:20px;}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:center;margin-bottom:16px}
  header h1{margin:0;font-size:28px;color:var(--green)}
  .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 8px 20px rgba(9,20,30,0.06)}
  .controls{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .controls input[type=search]{width:100%;max-width:420px;padding:10px;border-radius:8px;border:1px solid #e6e9ea}
  .smallSelect{padding:8px;border-radius:8px;border:1px solid #e6e9ea;background:#fff}
  .btn{background:var(--green);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--muted);border:1px solid #e6e9ea}
  .tableWrap{overflow-x:auto;margin-top:12px}
  table{border-collapse:collapse;width:100%;min-width:820px}
  thead th{background:var(--green);color:#fff;padding:12px 10px;text-align:left}
  tbody td{padding:12px 10px;border-bottom:1px solid #f1f2f3;vertical-align:middle}
  .status-paid{background:#d1fae5;color:#065f46;padding:4px 8px;border-radius:8px;font-weight:600}
  .status-pending{background:#fef3c7;color:#92400e;padding:4px 8px;border-radius:8px;font-weight:600}
  .formRow{display:flex;flex-direction:column;gap:10px;margin-top:14px}
  .formRow .row{display:flex;gap:10px;flex-wrap:wrap}
  .formRow input,.formRow select{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ea}
  .leftAction{width:56px;text-align:center}
  .waBtn{background:var(--green);color:#fff;border:none;border-radius:8px;padding:6px 8px;cursor:pointer;font-weight:600}
  .muted{color:var(--muted)}
  .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .pageBtn{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ea;background:#fff;cursor:pointer}
  .pageBtn.active{background:var(--green);color:#fff;border-color:var(--green)}
  .pageInfo{margin-right:auto;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>PERFECT DIGITAL NETWORK</h1></header>

  <div class="card">
    <div class="controls">
      <input id="searchBox" type="search" placeholder="Search client, mobile, address or remark" />
      <select id="monthSel" class="smallSelect">
        <option value="all">All months</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10" selected>October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      <select id="refreshSel" class="smallSelect">
        <option value="0">Refresh off</option>
        <option value="15">15s</option>
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
      </select>
      <button id="filterPendingBtn" class="btn ghost">Pending only</button>
      <button id="reloadBtn" class="btn">Reload</button>
      <div style="margin-left:auto" id="msg" class="muted"></div>
    </div>

    <div class="tableWrap">
      <table id="dataTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
    </div>

    <div class="pagination">
      <div id="pageInfo" class="pageInfo">Page 1</div>
      <button class="pageBtn" id="prevBtn">Prev</button>
      <button class="pageBtn" id="nextBtn">Next</button>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid #eee" />
    <h2>Add New Pending Client</h2>
    <div class="formRow">
      <div class="row">
        <input id="f_name" placeholder="Client Name">
        <input id="f_mobile" placeholder="Mobile">
      </div>
      <div class="row">
        <input id="f_amount" placeholder="Amount">
        <input id="f_date" placeholder="Date (e.g. 10/1/2025)">
      </div>
      <div class="row">
        <select id="f_status"><option>pending</option><option>paid</option></select>
        <select id="f_address">
          <option value="">--Select Area--</option>
          <option>Wazirpur</option>
          <option>Shas/Trinagar</option>
          <option>Ashok Vihar</option>
          <option>Gulabi Bagh</option>
        </select>
      </div>
      <div class="row">
        <input id="f_remark" placeholder="Remark (optional)">
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button id="addBtn" class="btn">Add</button>
        <div id="addMsg" class="muted"></div>
      </div>
    </div>
  </div>
</div>

<script>
const SHEETDB_API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd';
const CANON = ['clientname','mobile','amount','date','status','address','remark'];

let rawRows=[], headerMap={}, currentPage=1, PAGE_SIZE=20, filterPending=false;

function normKey(s){return String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function setMsg(m){document.getElementById('msg').textContent=m;}

function detectHeaders(rows){
  headerMap={}; if(!rows.length){CANON.forEach(c=>headerMap[c]=c);return;}
  const keys=Object.keys(rows[0]); const lookup={}; keys.forEach(k=>lookup[normKey(k)]=k);
  CANON.forEach(c=>headerMap[c]=lookup[normKey(c)]||c);
}

function getCell(r,c){return r[headerMap[c]]||'';}

async function fetchData(){
  setMsg('Loading…');
  const res=await fetch(SHEETDB_API); const data=await res.json();
  rawRows=Array.isArray(data)?data:data.data||[]; detectHeaders(rawRows);
  setMsg(''); renderTable();
}

function parseMonth(s){const d=new Date(s);return isNaN(d)?null:d.getMonth()+1;}

function getFilteredRows(){
  const q=document.getElementById('searchBox').value.toLowerCase(),mSel=document.getElementById('monthSel').value;
  return rawRows.filter(r=>{
    const hay=Object.values(r).join(' ').toLowerCase();
    if(q&&!hay.includes(q))return false;
    if(filterPending&&!getCell(r,'status').toLowerCase().includes('pending'))return false;
    if(mSel!=='all'){const m=parseMonth(getCell(r,'date'));if(m!=mSel)return false;}
    return true;
  });
}

function renderTable(){
  const tb=document.getElementById('tableBody'),th=document.getElementById('tableHead');
  tb.innerHTML='';th.innerHTML='';
  const titles=['Send','Client Name','Mobile','Amount','Date','Status','Address','Remark','Edit'];
  const trh=document.createElement('tr');titles.forEach(t=>{const thd=document.createElement('th');thd.textContent=t;trh.appendChild(thd);});th.appendChild(trh);
  const rows=getFilteredRows();const start=(currentPage-1)*PAGE_SIZE;const pageRows=rows.slice(start,start+PAGE_SIZE);
  pageRows.forEach(r=>{
    const tr=document.createElement('tr');
    const phone=getCell(r,'mobile'),msg=`Hello ${getCell(r,'clientname')}, your broadband payment of ₹${getCell(r,'amount')} is pending. Please pay via UPI ID: perfectdigital@axl. If you've already paid, please ignore. UPI QR — CLICK ON THE LINK TO OPEN: https://agichaniprakash-cloud.github.io/PerfectDigital/Screenshot_20251005_074910_PhonePe.jpg`;
    const waLink=phone?`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`:`#`;
    tr.innerHTML=`
      <td><button class="waBtn" onclick="window.open('${waLink}','_blank')">Send</button></td>
      <td>${escapeHtml(getCell(r,'clientname'))}</td>
      <td>${escapeHtml(phone)}</td>
      <td>${escapeHtml(getCell(r,'amount'))}</td>
      <td>${escapeHtml(getCell(r,'date'))}</td>
      <td>${getCell(r,'status').toLowerCase()==='paid'?'<span class="status-paid">Paid</span>':'<span class="status-pending">Pending</span>'}</td>
      <td>${escapeHtml(getCell(r,'address'))}</td>
      <td>${escapeHtml(getCell(r,'remark'))}</td>
      <td><button class="btn ghost" onclick='editRow(${JSON.stringify(JSON.stringify(r))})'>Edit</button></td>`;
    tb.appendChild(tr);
  });
  document.getElementById('pageInfo').textContent=`Page ${currentPage}`;
}

async function editRow(rowStr){
  const row=JSON.parse(rowStr);
  const name=prompt('Client Name',getCell(row,'clientname'));
  const mobile=prompt('Mobile',getCell(row,'mobile'));
  const amount=prompt('Amount',getCell(row,'amount'));
  const date=prompt('Date',getCell(row,'date'));
  const status=prompt('Status (paid/pending)',getCell(row,'status'));
  const address=prompt('Address',getCell(row,'address'));
  const remark=prompt('Remark',getCell(row,'remark'));

  const patch={};
  patch[headerMap['clientname']]=''+name;
  patch[headerMap['mobile']]=''+mobile;
  patch[headerMap['amount']]=''+amount;
  patch[headerMap['date']]=''+date;
  patch[headerMap['status']]=''+status;
  patch[headerMap['address']]=''+address;
  patch[headerMap['remark']]=''+remark;

  const key=mobile||name;
  const url=SHEETDB_API+'/mobile/'+encodeURIComponent(key);
  await fetch(url,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:[patch]})});
  fetchData();
}

async function addRow(){
  const payload={};
  ['clientname','mobile','amount','date','status','address','remark'].forEach((k,i)=>{
    const id='f_'+k.split('_')[0];
    payload[k]=document.getElementById(id).value.trim();
  });
  await fetch(SHEETDB_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:[payload]})});
  fetchData();
}

document.getElementById('addBtn').onclick=addRow;
document.getElementById('searchBox').oninput=()=>{currentPage=1;renderTable();};
document.getElementById('filterPendingBtn').onclick=e=>{filterPending=!filterPending;renderTable();};
document.getElementById('reloadBtn').onclick=fetchData;
document.getElementById('monthSel').onchange=()=>{currentPage=1;renderTable();};
document.getElementById('nextBtn').onclick=()=>{currentPage++;renderTable();};
document.getElementById('prevBtn').onclick=()=>{if(currentPage>1)currentPage--;renderTable();};
fetchData();
</script>
</body>
</html>
