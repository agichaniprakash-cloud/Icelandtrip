<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PERFECT DIGITAL NETWORK – Pending Payments</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --green:#138a55;
    --muted:#6b6f72;
    --card:#ffffff;
    --bg:#f6f7f8;
    --radius:10px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#1f2933;padding:24px;}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:center;margin-bottom:18px}
  header h1{margin:0;font-size:28px;color:var(--green)}
  .card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 8px 20px rgba(9,20,30,0.06)}
  .controls{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .controls input[type=search]{width:100%;max-width:480px;padding:10px;border-radius:8px;border:1px solid #e6e9ea}
  .btn{background:var(--green);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--muted);border:1px solid #e6e9ea}
  .tableWrap{overflow-x:auto;margin-top:12px}
  table{border-collapse:collapse;width:100%;min-width:700px}
  thead th{background:var(--green);color:#fff;padding:12px 10px;text-align:left}
  tbody td{padding:12px 10px;border-bottom:1px solid #f1f2f3;vertical-align:middle}
  .status-paid{background:#d1fae5;color:#065f46;padding:4px 8px;border-radius:8px;font-weight:600}
  .status-pending{background:#fef3c7;color:#92400e;padding:4px 8px;border-radius:8px;font-weight:600}
  .formRow{display:flex;flex-direction:column;gap:10px;margin-top:14px}
  .formRow .row{display:flex;gap:10px;flex-wrap:wrap}
  .formRow input,.formRow select{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ea}
  .muted{color:var(--muted)}
  @media (max-width:780px){
    .formRow .row{flex-direction:column}
    .controls input[type=search]{max-width:100%}
  }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>PERFECT DIGITAL NETWORK</h1></header>

  <div class="card">
    <div class="controls">
      <input id="searchBox" type="search" placeholder="Search client, mobile or address" />
      <select id="refreshSel" title="Auto refresh">
        <option value="0">Refresh off</option>
        <option value="15">Refresh every 15s</option>
        <option value="30">Refresh every 30s</option>
        <option value="60" selected>Refresh every 60s</option>
      </select>
      <button id="filterPendingBtn" class="btn ghost">Show: Pending only</button>
      <button id="reloadBtn" class="btn">Reload now</button>
      <div style="margin-left:auto" id="msg" class="muted"></div>
    </div>

    <div class="tableWrap">
      <table id="dataTable" role="table" aria-label="Pending payments">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid #eee" />

    <h2>Add New Pending Client</h2>
    <div class="formRow">
      <div class="row">
        <input id="f_name" placeholder="Client Name" />
        <input id="f_mobile" placeholder="Mobile" />
      </div>
      <div class="row">
        <input id="f_amount" placeholder="Amount" />
        <input id="f_date" placeholder="Date (e.g. 10/1/2025)" />
      </div>
      <div class="row">
        <select id="f_status">
          <option>pending</option>
          <option>paid</option>
        </select>
        <select id="f_address">
          <option value="">-- Select Area --</option>
          <option>Wazirpur</option>
          <option>Shas/Trinagar</option>
          <option>Ashok Vihar</option>
          <option>Gulabi Bagh</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
        <button id="addBtn" class="btn">Add</button>
        <div id="addMsg" class="muted"></div>
      </div>
    </div>
  </div>
</div>

<script>
const SHEETDB_API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd';
const canonical = ["clientname","mobile","amount","date","status","address"];
let lastData = [];
let headerMap = {};
let filterPending = false;
let refreshTimer = null;

/* normalize header names */
function norm(s){ return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[_\-]+/g,'').replace(/[^a-z0-9]/g,''); }

/* fetch data and render */
async function fetchData(){
  try{
    const res = await fetch(SHEETDB_API);
    const data = await res.json();
    lastData = Array.isArray(data) ? data : [];
    detectHeaders(lastData);
    renderTable(lastData);
  }catch(e){ console.error(e); document.getElementById('msg').textContent='Error loading data'; }
}

/* detect sheet headers */
function detectHeaders(data){
  headerMap={};
  if(data && data.length){
    const keys=Object.keys(data[0]); const lookup={}; keys.forEach(k=>lookup[norm(k)]=k);
    canonical.forEach(c=>{
      const variants={clientname:['client','name'],mobile:['mobile','phone'],amount:['amount','amt'],date:['date','duedate'],status:['status'],address:['address','remark','area']};
      let found=null; [c,...(variants[c]||[])].forEach(v=>{if(!found&&lookup[norm(v)])found=lookup[norm(v)];});
      headerMap[c]=found||keys[0];
    });
  }else canonical.forEach(c=>headerMap[c]=c);
}

/* render table */
function renderTable(data){
  const th=document.getElementById('tableHead'), tb=document.getElementById('tableBody');
  th.innerHTML=''; tb.innerHTML='';
  const titles={clientname:'Client Name',mobile:'Mobile',amount:'Amount',date:'Date',status:'Status',address:'Address'};
  const headRow=document.createElement('tr');
  Object.keys(titles).forEach(k=>{const thcell=document.createElement('th');thcell.textContent=titles[k];headRow.appendChild(thcell);});
  const thEdit=document.createElement('th');thEdit.textContent='Edit';headRow.appendChild(thEdit);
  th.appendChild(headRow);

  const q=document.getElementById('searchBox').value.trim().toLowerCase();
  (data||[]).forEach(row=>{
    const visible=Object.values(row).join(' ').toLowerCase().includes(q);
    if(!visible) return;
    if(filterPending && !String(row[headerMap['status']]||'').toLowerCase().includes('pending')) return;
    const tr=document.createElement('tr');
    canonical.forEach(k=>{
      const td=document.createElement('td');
      const actualKey=headerMap[k];
      td.textContent=(actualKey && row[actualKey]!==undefined)?row[actualKey]:'';
      tr.appendChild(td);
    });
    const tdEdit=document.createElement('td');
    const btn=document.createElement('button');
    btn.textContent='Edit';
    btn.className='btn ghost';
    btn.onclick=()=>editRow(row);
    tdEdit.appendChild(btn);
    tr.appendChild(tdEdit);
    tb.appendChild(tr);
  });
}

/* add client */
document.getElementById('addBtn').addEventListener('click',async()=>{
  const name=f_name.value.trim(),mobile=f_mobile.value.trim(),amount=f_amount.value.trim(),date=f_date.value.trim(),status=f_status.value.trim(),address=f_address.value.trim();
  if(!name&&!mobile){alert('Enter name or mobile');return;}
  const payload={};
  payload[headerMap['clientname']||'clientname']=name;
  payload[headerMap['mobile']||'mobile']=mobile;
  payload[headerMap['amount']||'amount']=amount;
  payload[headerMap['date']||'date']=date;
  payload[headerMap['status']||'status']=status;
  payload[headerMap['address']||'address']=address;
  try{
    addMsg.textContent='Adding...';
    await fetch(SHEETDB_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:[payload]})});
    await fetchData(); addMsg.textContent='Added ✓'; setTimeout(()=>addMsg.textContent='',1500);
    ['f_name','f_mobile','f_amount','f_date'].forEach(id=>document.getElementById(id).value=''); f_status.value='pending'; f_address.value='';
  }catch(e){console.error(e);addMsg.textContent='Error';}
});

/* edit client */
async function editRow(row){
  const name = prompt('Client Name:', row[headerMap['clientname']] || '');
  const mobile = prompt('Mobile:', row[headerMap['mobile']] || '');
  const amount = prompt('Amount:', row[headerMap['amount']] || '');
  const date = prompt('Date:', row[headerMap['date']] || '');
  const status = prompt('Status (paid/pending):', row[headerMap['status']] || '');
  const address = prompt('Address:', row[headerMap['address']] || '');

  const patch = {};
  patch[headerMap['clientname']] = name;
  patch[headerMap['mobile']] = mobile;
  patch[headerMap['amount']] = amount;
  patch[headerMap['date']] = date;
  patch[headerMap['status']] = status;
  patch[headerMap['address']] = address;

  try{
    const res = await fetch(`${SHEETDB_API}/mobile/${encodeURIComponent(row[headerMap['mobile']])}`, {
      method:'PATCH',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ data:[patch] })
    });
    if(!res.ok) throw new Error(res.statusText);
    alert('Updated successfully!');
    fetchData();
  }catch(e){ alert('Error updating: '+e.message); }
}

/* filters & reload */
document.getElementById('reloadBtn').onclick=fetchData;
document.getElementById('searchBox').oninput=()=>renderTable(lastData);
document.getElementById('filterPendingBtn').onclick=(e)=>{filterPending=!filterPending;e.target.classList.toggle('btn',filterPending);e.target.classList.toggle('ghost',!filterPending);renderTable(lastData);}
document.getElementById('refreshSel').onchange=(e)=>{const v=Number(e.target.value);if(refreshTimer)clearInterval(refreshTimer);if(v>0)refreshTimer=setInterval(fetchData,v*1000);}
fetchData();
</script>
</body>
</html>
