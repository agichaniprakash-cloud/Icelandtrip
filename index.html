<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PERFECT DIGITAL NETWORK – Pending Payments</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --green:#138a55;
    --muted:#6b6f72;
    --card:#ffffff;
    --bg:#f6f7f8;
    --radius:10px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#1f2933;padding:28px;}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:center;margin-bottom:22px}
  header h1{margin:0;font-size:30px;font-weight:700;color:var(--green)}
  .card{background:var(--card);padding:22px;border-radius:var(--radius);box-shadow:0 8px 20px rgba(9,20,30,0.06)}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
  .controls input[type=search]{width:100%;max-width:540px;padding:12px;border-radius:8px;border:1px solid #e6e9ea}
  .btn{background:var(--green);color:white;padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
  .btn.ghost{background:#fff;border:1px solid #e6e9ea;color:var(--muted)}
  .tableWrap{overflow-x:auto;margin-top:12px}
  table{border-collapse:collapse;width:100%;min-width:700px}
  thead th{background:var(--green);color:#fff;padding:18px 14px;text-align:left}
  tbody td{padding:18px 14px;border-bottom:1px solid #f1f2f3}
  .formRow{display:flex;flex-direction:column;gap:10px;margin-top:20px}
  .formRow input,.formRow select,.formRow textarea{padding:12px;border-radius:8px;border:1px solid #e6e9ea}
  .formRow .row{display:flex;gap:10px;flex-wrap:wrap}
  .formRow .row input{flex:1}
  .notice{font-size:13px;color:var(--muted);margin-top:12px}
  @media(min-width:900px){
    .formRow .row{flex-direction:row}
    .controls input[type=search]{width:540px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>PERFECT DIGITAL NETWORK</h1></header>

  <div class="card">
    <div class="controls">
      <input id="searchBox" type="search" placeholder="Search client, mobile or address" />
      <select id="refreshSel" title="Auto refresh">
        <option value="0">Refresh off</option>
        <option value="15">Refresh every 15s</option>
        <option value="30">Refresh every 30s</option>
        <option value="60" selected>Refresh every 60s</option>
      </select>
      <button id="filterPendingBtn" class="btn ghost">Show: Pending only</button>
      <button id="reloadBtn" class="btn">Reload now</button>
    </div>

    <div class="tableWrap">
      <table id="dataTable" role="table" aria-label="Pending payments">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <hr style="margin:18px 0;border:none;border-top:1px solid #eee" />

    <h2>Add New Pending Client</h2>
    <div class="formRow">
      <div class="row">
        <input id="f_name" placeholder="Client Name" />
        <input id="f_mobile" placeholder="Mobile" />
      </div>
      <div class="row">
        <input id="f_amount" placeholder="Amount" />
        <input id="f_date" placeholder="Date (e.g. 10/1/2025)" />
      </div>
      <div class="row">
        <select id="f_status">
          <option>pending</option>
          <option>paid</option>
          <option>other</option>
        </select>

        <!-- Address dropdown as requested -->
        <select id="f_address">
          <option value="">-- Select Area --</option>
          <option>Wazirpur</option>
          <option>Shas/Trinagar</option>
          <option>Ashok Vihar</option>
          <option>Gulabi Bagh</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <button id="addBtn" class="btn">Add</button>
        <div id="msg" style="color:var(--muted)"></div>
      </div>
      <div class="notice">Tip: choose area from the dropdown before adding new client.</div>
    </div>
  </div>
</div>

<script>
/* Only change from Code X1: remark removed, address added (dropdown).
   Safe header detection: prefer 'address' column, fall back to reading from 'remark' (so old data still visible).
   When posting, will write to 'address' (creating the column if not present).
*/

const SHEETDB_API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd';

// canonical now includes address
const CANONICAL = ['clientname','mobile','amount','date','status','address'];

function normKey(s){
  return String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
}

let rawRows = [];
let headerMap = {};
let refreshTimer = null;
let filterPending = false;

// detect headers safely (prefer address; if address missing but remark exists, map address -> remark key)
function detectHeaders(rows){
  headerMap = {};
  if(Array.isArray(rows) && rows.length){
    const keys = Object.keys(rows[0]);
    const lookup = {};
    keys.forEach(k => lookup[normKey(k)] = k);

    const variants = {
      clientname:['clientname','client','name','client_name','client name'],
      mobile:['mobile','phone','phonenumber','mobilephone','mobile_number','phone_number'],
      amount:['amount','amt','price'],
      date:['date','duedate','due_date','billingdate'],
      status:['status','paymentstatus','st','payment_status'],
      address:['address','addr','location'] // prefer address variants
    };

    CANONICAL.forEach(c => {
      if(lookup[normKey(c)]){ headerMap[c] = lookup[normKey(c)]; return; }
      let found = null;
      const vs = variants[c] || [c];
      for(const v of vs){
        if(lookup[normKey(v)]){ found = lookup[normKey(v)]; break; }
      }
      if(found){ headerMap[c] = found; return; }

      // special fallback for address: if sheet has 'remark' or 'remarks', map address -> that key so existing data shows
      if(c === 'address'){
        if(lookup['remark']) { headerMap[c] = lookup['remark']; return; }
        if(lookup['remarks']) { headerMap[c] = lookup['remarks']; return; }
      }

      // safe default: canonical name (so POST will create this column instead of overwriting existing ones)
      headerMap[c] = c;
    });
  } else {
    // no rows yet
    CANONICAL.forEach(c => headerMap[c] = c);
  }
}

// safe get cell using headerMap with small fallbacks
function getCell(row, canonical){
  if(!row) return '';
  const ak = headerMap[canonical];
  if(ak && row.hasOwnProperty(ak)) return row[ak];
  // fallback list per key
  const fallbacks = {
    clientname: ['Client Name','clientname','name'],
    mobile: ['mobile','Mobile','phone'],
    amount: ['amount','Amount','amt'],
    date: ['date','Date'],
    status: ['status','Status'],
    address: ['address','Address','remark','Remark','remarks']
  };
  const alts = fallbacks[canonical] || [];
  for(const a of alts){
    if(row.hasOwnProperty(a)) return row[a];
  }
  return '';
}

// fetch and render
async function fetchData(){
  try{
    msg.textContent = 'Loading…';
    const res = await fetch(SHEETDB_API);
    if(!res.ok) throw new Error('Fetch failed: ' + res.status);
    const json = await res.json();
    rawRows = Array.isArray(json) ? json : (json.data || []);
    detectHeaders(rawRows);
    renderTable();
    msg.textContent = '';
  }catch(err){
    console.error(err);
    msg.textContent = 'Error loading data — check API & console';
  }
}

function renderTable(){
  const head = document.getElementById('tableHead');
  const body = document.getElementById('tableBody');
  head.innerHTML = ''; body.innerHTML = '';

  // headers: address replaces remark
  const titles = { clientname:'Client Name', mobile:'Mobile', amount:'Amount', date:'Date', status:'Status', address:'Address' };
  const hRow = document.createElement('tr');
  Object.keys(titles).forEach(k => {
    const th = document.createElement('th'); th.textContent = titles[k]; hRow.appendChild(th);
  });
  head.appendChild(hRow);

  const q = (document.getElementById('searchBox').value || '').trim().toLowerCase();

  const rows = rawRows.filter(r => {
    const hay = Object.values(r).join(' ').toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(filterPending){
      const st = (getCell(r,'status') || '').toString().toLowerCase();
      if(!st.includes('pending')) return false;
    }
    return true;
  });

  if(!rows.length){
    body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">No records found</td></tr>';
    return;
  }

  for(const r of rows){
    const tr = document.createElement('tr');
    const name = getCell(r,'clientname') || '';
    const mobile = getCell(r,'mobile') || '';
    const amount = getCell(r,'amount') || '';
    const date = getCell(r,'date') || '';
    const statusRaw = (getCell(r,'status') || '').toString().toLowerCase();
    const address = getCell(r,'address') || '';

    const statusHtml = statusRaw === 'paid'
      ? `<span style="background:#d1fae5;color:#065f46;padding:4px 10px;border-radius:8px;font-weight:600">Paid</span>`
      : `<span style="background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:8px;font-weight:600">Pending</span>`;

    tr.innerHTML = `
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(mobile)}</td>
      <td>${escapeHtml(amount)}</td>
      <td>${escapeHtml(date)}</td>
      <td>${statusHtml}</td>
      <td>${escapeHtml(address)}</td>
    `;
    body.appendChild(tr);
  }
}

function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

// add row
async function addRow(){
  const name = document.getElementById('f_name').value.trim();
  const mobile = document.getElementById('f_mobile').value.trim();
  const amount = document.getElementById('f_amount').value.trim();
  const date = document.getElementById('f_date').value.trim();
  const status = document.getElementById('f_status').value.trim();
  const address = document.getElementById('f_address').value.trim();

  if(!name && !mobile){ alert('Please provide at least Client Name or Mobile.'); return; }

  if(!Object.keys(headerMap).length) await fetchData();

  const payload = {};
  payload[ headerMap['clientname'] || 'clientname' ] = name || '';
  payload[ headerMap['mobile'] || 'mobile' ] = mobile || '';
  payload[ headerMap['amount'] || 'amount' ] = amount || '';
  payload[ headerMap['date'] || 'date' ] = date || '';
  payload[ headerMap['status'] || 'status' ] = status || '';
  // Important: write to address column (prefer actual 'address' key; if headerMap mapped address->remark that's fine)
  payload[ headerMap['address'] || 'address' ] = address || '';

  try{
    msg.textContent = 'Adding…';
    const res = await fetch(SHEETDB_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: [ payload ] })
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || res.status);
    }

    // reload
    await fetchData();

    // quick verification that row exists (by mobile or name)
    const found = rawRows.some(r => {
      const nm = (getCell(r,'clientname') || '').toString().trim();
      const mob = (getCell(r,'mobile') || '').toString().trim();
      return (mobile && mob === mobile) || (name && nm === name);
    });

    if(!found){
      msg.textContent = 'Added — but could not verify placement. Check Sheet headers.';
      console.warn('Add verification failed. headerMap:', headerMap, 'payload:', payload, 'sample rows:', rawRows.slice(0,3));
      return;
    }

    // success: clear form
    ['f_name','f_mobile','f_amount','f_date'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('f_address').value = '';
    document.getElementById('f_status').value = 'pending';
    msg.textContent = 'Added ✓';
    setTimeout(()=>msg.textContent = '', 1600);
  }catch(err){
    console.error(err);
    alert('Add failed — see console');
    msg.textContent = '';
  }
}

/* UI wiring */
document.getElementById('reloadBtn').addEventListener('click', fetchData);
document.getElementById('searchBox').addEventListener('input', renderTable);
document.getElementById('filterPendingBtn').addEventListener('click', (e) => { filterPending = !filterPending; e.target.classList.toggle('btn', filterPending); e.target.classList.toggle('ghost', !filterPending); renderTable(); });
document.getElementById('refreshSel').addEventListener('change', (e) => { const v = Number(e.target.value); if(refreshTimer){ clearInterval(refreshTimer); refreshTimer = null; } if(v>0) refreshTimer = setInterval(fetchData, v*1000); });
document.getElementById('addBtn').addEventListener('click', addRow);

/* init */
fetchData();
</script>
</body>
</html>
