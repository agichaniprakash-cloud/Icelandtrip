<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pending Payments â€” Codex3</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --green:#138a55;
    --muted:#6b6f72;
    --card:#ffffff;
    --bg:#f6f7f8;
    --radius:10px;
    --accent:#f59e0b; /* orange for pending badges */
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#1f2933;padding:18px;}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px;align-items:flex-start}
  header .brand{display:flex;gap:12px;align-items:center}
  header h1{margin:0;font-size:28px}
  header .sub{color:var(--muted);font-size:14px}
  .card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 8px 20px rgba(9,20,30,0.06)}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
  .controls input[type=search]{width:100%;max-width:540px;padding:12px;border-radius:8px;border:1px solid #e6e9ea}
  .controls .small{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ea;background:#fff}
  .btn{background:var(--green);color:white;padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
  .btn.ghost{background:#fff;border:1px solid #e6e9ea;color:var(--muted)}
  .btn.small{padding:8px 10px;font-size:14px}
  .tableWrap{overflow-x:auto;margin-top:12px}
  table{border-collapse:collapse;width:100%;min-width:760px}
  thead th{background:var(--green);color:#fff;padding:14px 12px;text-align:left}
  tbody td{padding:14px 12px;border-bottom:1px solid #f1f2f3;vertical-align:middle}
  .badge-pending{background:var(--accent);color:#fff;padding:6px 10px;border-radius:999px;display:inline-block}
  .actions{display:flex;gap:8px}
  .actions .btn{background:#fff;border:1px solid #e6e9ea;color:var(--green);padding:6px 10px;border-radius:8px}
  .formRow{display:flex;flex-direction:column;gap:10px;margin-top:20px}
  .formRow input,.formRow select, .formRow textarea{padding:12px;border-radius:8px;border:1px solid #e6e9ea}
  .formRow .row{display:flex;gap:10px}
  .formRow .row input{flex:1}
  .notice{font-size:13px;color:var(--muted);margin-top:12px}
  .stats{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .stat{background:#f0fbf5;border-radius:10px;padding:12px;color:var(--muted)}
  .qr{max-width:90px;border-radius:8px}
  .pager{display:flex;gap:8px;align-items:center;margin-top:12px}
  .smallSelect{padding:8px;border-radius:8px;border:1px solid #e6e9ea;background:#fff}
  @media(min-width:900px){ .formRow .row{flex-direction:row} .controls input[type=search]{width:540px}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div style="font-size:34px">ðŸ“¶</div>
      <div>
        <h1>PERFECT DIGITAL NETWORK</h1>
        <div class="sub">Pending payments dashboard (Live)</div>
      </div>
    </div>
    <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
      <img id="qrImg" src="" alt="UPI QR" class="qr" />
      <div style="text-align:right;color:var(--muted);font-size:13px">UPI: <span id="upiText"></span></div>
    </div>
  </header>

  <div class="card" id="mainCard">
    <div class="controls">
      <input id="searchBox" type="search" placeholder="Search client, mobile or address" />
      <select id="refreshSel" class="smallSelect" title="Auto refresh">
        <option value="0">No Auto-refresh</option>
        <option value="15">Every 15s</option>
        <option value="30">Every 30s</option>
        <option value="60" selected>Every 60s</option>
      </select>

      <button id="pendingBtn" class="btn ghost small">Pending only</button>
      <button id="reloadBtn" class="btn small">Reload now</button>

      <div style="margin-left:auto" class="stats">
        <div class="stat">Total clients: <strong id="statTotal">â€”</strong></div>
        <div class="stat">Pending count: <strong id="statPendingCount">â€”</strong></div>
        <div class="stat">Pending amount: <strong id="statPendingAmount">â€”</strong></div>
      </div>
    </div>

    <div style="margin-bottom:12px">
      <button class="btn ghost small" data-area="all">All</button>
      <button class="btn ghost small" data-area="wazirpur">Wazirpur</button>
      <button class="btn ghost small" data-area="shas">Shas/Trinagar</button>
      <button class="btn ghost small" data-area="ashok">Ashok Vihar</button>
      <button class="btn ghost small" data-area="gulabi">Gulabi Bagh</button>
    </div>

    <div class="tableWrap" id="tableWrap">
      <table id="dataTable" role="table" aria-label="Pending payments table">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="pager">
      <label>Show per page:</label>
      <select id="perPage" class="smallSelect">
        <option>10</option>
        <option selected>20</option>
        <option>50</option>
      </select>
      <button id="prevBtn" class="btn ghost small">Prev</button>
      <button id="nextBtn" class="btn ghost small">Next</button>
      <div style="margin-left:8px;color:var(--muted)">Page <span id="pageNo">1</span></div>
    </div>

    <hr style="margin:18px 0;border:none;border-top:1px solid #eee" />

    <h2>Add new client</h2>
    <div class="formRow">
      <div class="row">
        <input id="f_name" placeholder="Client name" />
        <input id="f_mobile" placeholder="Mobile" />
      </div>
      <div class="row">
        <input id="f_amount" placeholder="Amount (â‚¹)" />
        <input id="f_date" placeholder="Date (DD/MM/YYYY or MM/DD/YYYY)" />
      </div>
      <div class="row">
        <select id="f_status">
          <option>pending</option>
          <option>paid</option>
        </select>
        <select id="f_address">
          <option value="">-- choose address --</option>
          <option value="wazirpur">Wazirpur</option>
          <option value="shas">Shas/Trinagar</option>
          <option value="ashok">Ashok Vihar</option>
          <option value="gulabi">Gulabi Bagh</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <button id="addBtn" class="btn">Add client</button>
        <div id="msg" style="color:var(--muted)"></div>
      </div>
      <div class="notice">Tip: publishing your sheet (CSV) makes the site live. Use the form to add rows via SheetDB.</div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const SHEETDB_API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd'; // your SheetDB endpoint
const UPI_ID = 'perfectdigital@axl';            // set your UPI id here
const QR_IMG_URL = 'https://raw.githubusercontent.com/<USER>/<REPO>/main/qr.png'; // replace with your QR image URL
/* ==================== */

document.getElementById('upiText').textContent = UPI_ID;
document.getElementById('qrImg').src = QR_IMG_URL;

// canonical fields we expect
const canonical = ["clientname","mobile","amount","date","status","address"];

// normalize helper
function norm(s){
  return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[_\-]+/g,'').replace(/[^a-z0-9]/g,'');
}

let lastData = [];
let headerMap = {}; // canonical -> actual sheet key
let filterPending = false;
let currentArea = 'all';
let perPage = 20;
let pageNo = 1;

// --------------- fetch & detect headers ---------------
async function fetchData(){
  try{
    const res = await fetch(SHEETDB_API);
    if(!res.ok) throw new Error('Fetch failed: '+res.status);
    const data = await res.json();
    lastData = Array.isArray(data) ? data : [];
    detectHeaders(lastData);
    renderTable();
    updateStats();
    return lastData;
  }catch(e){
    console.error(e);
    document.getElementById('msg').textContent = 'Error loading data: '+e.message;
    // clear table head/body
    document.getElementById('tableHead').innerHTML = '';
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" style="color:crimson">Error loading data â€” check API_URL / SheetDB settings. See console.</td></tr>';
    return [];
  }
}

function detectHeaders(data){
  headerMap = {};
  if(data && data.length){
    const keys = Object.keys(data[0]);
    const lookup = {};
    keys.forEach(k => lookup[norm(k)] = k);
    const variants = {
      clientname:['clientname','client','name','client_name'],
      mobile:['mobile','phone','phonenumber','mobile_number','mobilephone'],
      amount:['amount','amt','price'],
      date:['date','duedate','due_date'],
      status:['status','statu'],
      address:['address','area','place','location']
    };
    canonical.forEach(c=>{
      const vs = variants[c]||[c];
      for(const v of vs){
        if(lookup[norm(v)]){ headerMap[c]=lookup[norm(v)]; break; }
      }
    });
    // fallback: if some canonical not matched, map to first key not used yet
    const used = new Set(Object.values(headerMap));
    let idx = 0;
    keys.forEach(k=>{
      if(used.has(k)) return;
      const need = canonical.find(c=>!headerMap[c]);
      if(need) headerMap[need] = k;
    });
  } else {
    // no rows yet â€” just map canonical to canonical
    canonical.forEach(c=> headerMap[c] = c);
  }
}

// --------------- rendering ---------------
function renderTable(){
  const th = document.getElementById('tableHead');
  const tb = document.getElementById('tableBody');
  th.innerHTML = ''; tb.innerHTML = '';

  // header
  const titles = { clientname:'Client Name', mobile:'Mobile', amount:'Amount (â‚¹)', date:'Date', status:'Status', address:'Address' };
  const headRow = document.createElement('tr');
  Object.keys(titles).forEach(k=>{
    const thcell = document.createElement('th');
    thcell.textContent = titles[k];
    headRow.appendChild(thcell);
  });
  // actions col
  const thActions = document.createElement('th');
  thActions.textContent = 'Actions';
  headRow.appendChild(thActions);

  th.appendChild(headRow);

  // search/filter/pagination
  const search = document.getElementById('searchBox').value.trim().toLowerCase();
  const filtered = (lastData||[]).filter(row => {
    // area filter
    if(currentArea !== 'all'){
      const aKey = headerMap['address'];
      const v = String(aKey ? (row[aKey]||'') : '').toLowerCase();
      if(!v.includes(currentArea)) return false;
    }
    // pending filter
    if(filterPending){
      const sKey = headerMap['status'];
      if(!String(sKey ? (row[sKey]||'') : '').toLowerCase().includes('pending')) return false;
    }
    // search
    if(search){
      const hay = Object.values(row).join(' ').toLowerCase();
      if(!hay.includes(search)) return false;
    }
    return true;
  });

  // pagination
  perPage = Number(document.getElementById('perPage').value || 20);
  const pages = Math.max(1, Math.ceil(filtered.length / perPage));
  pageNo = Math.max(1, Math.min(pageNo, pages));
  document.getElementById('pageNo').textContent = pageNo;

  const start = (pageNo-1)*perPage;
  const pageItems = filtered.slice(start, start + perPage);

  if(pageItems.length === 0){
    tb.innerHTML = '<tr><td colspan="8" style="color:var(--muted)">No clients to show.</td></tr>';
    return;
  }

  pageItems.forEach((row, idx) => {
    const tr = document.createElement('tr');

    // clientname
    const nameKey = headerMap['clientname'];
    const mobileKey = headerMap['mobile'];
    const amountKey = headerMap['amount'];
    const dateKey = headerMap['date'];
    const statusKey = headerMap['status'];
    const addressKey = headerMap['address'];

    const nameTd = document.createElement('td');
    nameTd.textContent = row[nameKey] || '';
    tr.appendChild(nameTd);

    const mobileTd = document.createElement('td');
    mobileTd.textContent = row[mobileKey] || '';
    tr.appendChild(mobileTd);

    const amountTd = document.createElement('td');
    amountTd.textContent = row[amountKey] || '';
    tr.appendChild(amountTd);

    const dateTd = document.createElement('td');
    dateTd.textContent = row[dateKey] || '';
    tr.appendChild(dateTd);

    const statusTd = document.createElement('td');
    const st = String(row[statusKey] || '').toLowerCase();
    if(st.includes('pending')){
      const span = document.createElement('span');
      span.className = 'badge-pending';
      span.textContent = 'pending';
      statusTd.appendChild(span);
    } else {
      statusTd.textContent = row[statusKey] || '';
    }
    tr.appendChild(statusTd);

    const addressTd = document.createElement('td');
    addressTd.textContent = row[addressKey] || '';
    tr.appendChild(addressTd);

    // actions
    const actTd = document.createElement('td');
    const actWrap = document.createElement('div');
    actWrap.className = 'actions';

    // Edit button â€” will populate form with row values (client must then Save manually by adding a new row or via Sheet edit)
    const editBtn = document.createElement('button');
    editBtn.className = 'btn';
    editBtn.textContent = 'Edit';
    editBtn.addEventListener('click', ()=> {
      // fill form with this row's data for quick editing
      document.getElementById('f_name').value = row[nameKey] || '';
      document.getElementById('f_mobile').value = row[mobileKey] || '';
      document.getElementById('f_amount').value = row[amountKey] || '';
      document.getElementById('f_date').value = row[dateKey] || '';
      document.getElementById('f_status').value = row[statusKey] || '';
      if(addressKey) document.getElementById('f_address').value = (row[addressKey] || '');
      // scroll to form
      document.getElementById('f_name').scrollIntoView({behavior:'smooth'});
    });
    actWrap.appendChild(editBtn);

    // WhatsApp send button
    const waBtn = document.createElement('button');
    waBtn.className = 'btn';
    waBtn.textContent = 'Send WhatsApp';
    waBtn.addEventListener('click', () => sendWhatsAppMsg(row));
    actWrap.appendChild(waBtn);

    actTd.appendChild(actWrap);
    tr.appendChild(actTd);

    tb.appendChild(tr);
  });
}

// --------------- stats ---------------
function updateStats(){
  const total = lastData.length;
  const pendingRows = lastData.filter(r => String(r[ headerMap['status'] ]||'').toLowerCase().includes('pending'));
  const pendingCount = pendingRows.length;
  const pendingAmount = pendingRows.reduce((sum, r) => {
    const a = Number((r[ headerMap['amount'] ]||'').toString().replace(/[^0-9.-]/g,''));
    return sum + (isNaN(a) ? 0 : a);
  }, 0);
  document.getElementById('statTotal').textContent = total || '0';
  document.getElementById('statPendingCount').textContent = pendingCount || '0';
  document.getElementById('statPendingAmount').textContent = pendingAmount ? 'â‚¹'+pendingAmount : 'â‚¹0';
}

// --------------- phone normalization + WhatsApp send ---------------
function normalizePhone(mob){
  if(!mob) return '';
  let digits = String(mob).replace(/\D/g,'');        // remove non-digit chars
  digits = digits.replace(/^0+/, '');                // remove leading zeros
  // if 10 digits -> assume India and add 91
  if(digits.length === 10) digits = '91' + digits;
  // If starts with country code like '91' or other and length >= 11, keep it
  return digits;
}

function sendWhatsAppMsg(row){
  const nameKey = headerMap['clientname'];
  const mobileKey = headerMap['mobile'];
  const amountKey = headerMap['amount'];

  const name = row[nameKey] || '';
  const rawMob = row[mobileKey] || '';
  const mob = normalizePhone(rawMob);
  const amount = row[amountKey] || '';

  const txt = `Hello ${name || ''}, your broadband payment of â‚¹${amount || ''} is pending. Please pay via UPI ID: ${UPI_ID}. If you've already paid, please ignore.`;

  let waUrl;
  if(mob && mob.length >= 11){
    waUrl = `https://wa.me/${mob}?text=${encodeURIComponent(txt)}`;
  } else {
    // fallback to web.whatsapp.com/send (opens WhatsApp Web with message â€” user must choose recipient)
    waUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(txt)}`;
  }
  window.open(waUrl, '_blank');
}

// --------------- add row ---------------
document.getElementById('addBtn').addEventListener('click', async () => {
  const name = document.getElementById('f_name').value.trim();
  const mobile = document.getElementById('f_mobile').value.trim();
  const amount = document.getElementById('f_amount').value.trim();
  const date = document.getElementById('f_date').value.trim();
  const status = document.getElementById('f_status').value.trim();
  const address = document.getElementById('f_address').value || '';

  if(!name && !mobile){ alert('Please enter at least client name or mobile'); return; }

  // ensure headers detected
  if(!Object.keys(headerMap).length) await fetchData();

  // build payload using detected headerMap
  const payloadObj = {};
  payloadObj[ headerMap['clientname'] || 'clientname' ] = name || '';
  payloadObj[ headerMap['mobile'] || 'mobile' ] = mobile || '';
  payloadObj[ headerMap['amount'] || 'amount' ] = amount || '';
  payloadObj[ headerMap['date'] || 'date' ] = date || '';
  payloadObj[ headerMap['status'] || 'status' ] = status || '';
  payloadObj[ headerMap['address'] || 'address' ] = address || '';

  const body = { data: [ payloadObj ] };

  try{
    const res = await fetch(SHEETDB_API, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    const j = await res.json();
    if(!res.ok){
      console.error('SheetDB error:', j);
      alert('Error adding row: '+(j.message||res.status));
      return;
    }
    document.getElementById('msg').textContent = 'Added â€” reloading...';
    ['f_name','f_mobile','f_amount','f_date','f_status','f_address'].forEach(id=>document.getElementById(id).value='');
    setTimeout(()=>fetchData().then(()=>document.getElementById('msg').textContent=''),500);
  }catch(err){
    console.error(err);
    alert('Network error adding row: '+err.message);
  }
});

// --------------- UI events ---------------
document.getElementById('reloadBtn').addEventListener('click', ()=>{ document.getElementById('msg').textContent='Reloading...'; fetchData().then(()=>document.getElementById('msg').textContent=''); });
document.getElementById('pendingBtn').addEventListener('click', (e) => { filterPending = !filterPending; e.target.classList.toggle('btn', filterPending); e.target.classList.toggle('ghost', !filterPending); renderTable(); });
document.getElementById('searchBox').addEventListener('input', ()=>{ pageNo=1; renderTable(); });
document.getElementById('perPage').addEventListener('change', ()=>{ pageNo=1; renderTable(); });
document.getElementById('prevBtn').addEventListener('click', ()=>{ pageNo = Math.max(1, pageNo-1); renderTable(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ pageNo = pageNo+1; renderTable(); });

document.querySelectorAll('[data-area]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    currentArea = e.target.getAttribute('data-area');
    pageNo = 1;
    renderTable();
  });
});

// refresh select auto-refresh
let refreshTimer = null;
document.getElementById('refreshSel').addEventListener('change', (e) => {
  const v = Number(e.target.value);
  if(refreshTimer){ clearInterval(refreshTimer); refreshTimer = null; }
  if(v>0) refreshTimer = setInterval(fetchData, v*1000);
});

// initial load
fetchData();
</script>
</body>
</html>
