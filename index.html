<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pending Payments</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#fff;margin:0;padding:32px;color:#111}
    .wrap{max-width:980px;margin:0 auto}
    h1{display:flex;align-items:center;gap:10px;font-size:28px}
    table{border-collapse:collapse;width:100%;margin-top:20px}
    th,td{border:1px solid #ddd;padding:12px;text-align:left}
    th{background:#f4f4f4;color:#111}
    tr:nth-child(even){background:#fbfbfb}
    .muted{color:#666;font-size:13px}
    .form-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:20px}
    .form-row input[type=text], .form-row input[type=date], .form-row input[type=number], .form-row select {
      padding:8px;border:1px solid #ccc;border-radius:6px;min-width:140px;box-sizing:border-box;
    }
    .btn{background:#2f9e44;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
    .notice{margin-top:12px;color:#333}
    .small{font-size:13px;color:#666;margin-top:8px}
    .top-row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .left {display:flex;align-items:center;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top-row">
      <div class="left">
        <h1>ðŸ“‹ Pending Payments</h1>
        <div class="small muted">Live from your Google Sheet (via SheetDB)</div>
      </div>
      <div>
        <button id="refreshBtn" class="btn">Refresh now</button>
      </div>
    </div>

    <!-- Table placeholder -->
    <div id="tableWrap">
      <div class="muted" id="loading">Loading data...</div>
    </div>

    <!-- Add new entry form -->
    <h3 style="margin-top:28px">Add new pending client</h3>
    <div class="form-row" id="entryForm">
      <input id="client" placeholder="Client Name" type="text" />
      <input id="mobile" placeholder="Mobile" type="text" />
      <input id="amount" placeholder="Amount" type="number" />
      <input id="date" placeholder="Date" type="date" />
      <select id="status"><option value="pending">pending</option><option value="received">received</option></select>
      <input id="remark" placeholder="Remark" type="text" />
      <button id="submitBtn" class="btn">Add</button>
    </div>
    <div id="message" class="small"></div>
  </div>

<script>
  // ====== CONFIG ======
  // paste your SheetDB api url here (the one you already created)
  const SHEETDB_API = 'https://sheetdb.io/api/v1/hm2cm71m0ury9';

  // how often table reloads (ms)
  const POLL_INTERVAL = 10000;

  // ====== UTIL ======
  function formatDateLocal(d) {
    if(!d) return '';
    const dt = new Date(d);
    if(isNaN(dt)) return d; // returns original string if invalid
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    const yyyy = dt.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
  }

  function daysPendingFrom(dateStr){
    if(!dateStr) return '';
    const d = new Date(dateStr);
    if(isNaN(d)) return '';
    const today = new Date();
    // compute whole days difference
    const diff = Math.floor((today - d) / (1000*60*60*24));
    return diff >= 0 ? diff : 0;
  }

  // ====== RENDER TABLE ======
  async function fetchAndRender(){
    const wrap = document.getElementById('tableWrap');
    const loading = document.getElementById('loading');
    loading && (loading.textContent = 'Loading data...');
    try {
      const res = await fetch(SHEETDB_API);
      if(!res.ok) throw new Error('Fetch failed');
      const data = await res.json();
      // data is an array of objects; keys come from your sheet headers.
      renderTable(data);
      loading && (loading.textContent = '');
    } catch(err) {
      wrap.innerHTML = '<div class="muted">Error loading data. Check SheetDB URL and network.</div>';
      console.error(err);
    }
  }

  function renderTable(rows){
    const wrap = document.getElementById('tableWrap');
    if(!rows || rows.length === 0){
      wrap.innerHTML = '<div class="muted">No data found</div>';
      return;
    }

    // Build header order â€” matching your sheet columns
    const headers = ['Client Name','Mobile','Amount','Date','Status','Remarks','Days Pending'];

    // Build table HTML
    let html = '<table><thead><tr>';
    headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';

    // Each item is an object with keys exactly as the sheet header (case may vary)
    rows.forEach(r => {
      // Try multiple common key spellings
      const client = r['Client Name'] || r['client name'] || r.client || r['Client'] || '';
      const mobile = r['Mobile'] || r.mobile || r['mobile'] || '';
      const amount = r['Amount'] || r.amount || '';
      const dateRaw = r['Date'] || r.date || r['date'] || '';
      const status = (r['Status'] || r.status || '').toString();
      const remarks = r['Remarks'] || r.Remarks || r.remark || r.Remarks || r['remark'] || '';

      const daysPending = (status.toLowerCase() === 'pending') ? daysPendingFrom(dateRaw) : '';

      html += `<tr>
        <td>${escapeHtml(client)}</td>
        <td>${escapeHtml(mobile)}</td>
        <td>${escapeHtml(amount)}</td>
        <td>${escapeHtml(formatDateLocal(dateRaw))}</td>
        <td>${escapeHtml(status)}</td>
        <td>${escapeHtml(remarks)}</td>
        <td>${escapeHtml(daysPending)}</td>
      </tr>`;
    });

    html += '</tbody></table>';
    wrap.innerHTML = html;
  }

  function escapeHtml(s){
    if(s === null || s === undefined) return '';
    return String(s).replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[c]);
  }

  // ====== SEND NEW ENTRY ======
  async function submitNew(){
    const client = document.getElementById('client').value.trim();
    const mobile = document.getElementById('mobile').value.trim();
    const amount = document.getElementById('amount').value.trim();
    const date = document.getElementById('date').value; // yyyy-mm-dd
    const status = document.getElementById('status').value;
    const remark = document.getElementById('remark').value.trim();

    if(!client){
      showMessage('Please enter client name', true); return;
    }
    // Build payload in SheetDB expected format:
    // { data: [ { "Client Name": "ramesh", "Mobile": "...", ... } ] }
    const payload = {
      data: [{
        "Client Name": client,
        "Mobile": mobile,
        "Amount": amount,
        "Date": date,
        "Status": status,
        "Remarks": remark
      }]
    };

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    showMessage('Sending...');

    try {
      const res = await fetch(SHEETDB_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Request failed ' + res.status);
      const result = await res.json();
      showMessage('Added! Table will refresh shortly.');
      // clear inputs
      document.getElementById('client').value = '';
      document.getElementById('mobile').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('date').value = '';
      document.getElementById('remark').value = '';
      // refresh immediately
      await fetchAndRender();
    } catch(err){
      console.error(err);
      showMessage('Error adding entry. Check console.', true);
    } finally {
      btn.disabled = false;
    }
  }

  function showMessage(text, isErr){
    const el = document.getElementById('message');
    el.textContent = text;
    el.style.color = isErr ? 'crimson' : '#333';
  }

  // ====== STARTUP ======
  document.getElementById('submitBtn').addEventListener('click', submitNew);
  document.getElementById('refreshBtn').addEventListener('click', fetchAndRender);

  // initial fetch + polling
  fetchAndRender();
  setInterval(fetchAndRender, POLL_INTERVAL);
</script>
</body>
</html>
