<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pending Payments — Perfect Digital Network</title>
  <style>
    /* --- simple modern styles --- */
    :root{
      --accent:#1f8a56;
      --accent-dark:#177043;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f7faf7;
      --pending:#f59e0b;
      --paid:#10b981;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:var(--bg);color:#0f172a}
    .wrap{max-width:980px;margin:28px auto;padding:22px}
    header.site{display:flex;align-items:center;gap:18px;background:#f1fbf6;border-radius:8px;padding:18px 22px}
    header.site h1{margin:0;font-size:26px;color:var(--accent-dark)}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:18px 0}
    .search{flex:1}
    input[type=text], select, textarea{width:100%;padding:12px;border:1px solid #e6eef0;border-radius:8px;font-size:15px}
    button{background:var(--accent);border:none;color:#fff;padding:10px 18px;border-radius:8px;font-weight:600;cursor:pointer}
    button.secondary{background:#fff;color:var(--accent);border:1px solid #e5f0ea}
    .btn-orange{background:var(--pending)}
    .top-stats{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    .stat{background:#fff;padding:14px;border-radius:10px;min-width:140px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
    .table-wrap{background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 30px rgba(16,24,40,0.04);margin-top:18px}
    table{width:100%;border-collapse:collapse;font-size:15px}
    thead th{background:var(--accent);color:white;padding:14px;text-align:left;border-radius:6px}
    tbody td{padding:16px;border-bottom:1px solid #f1f5f9}
    .status-pill{display:inline-block;padding:6px 10px;border-radius:999px;color:white;font-weight:600}
    .status-paid{background:var(--paid)}
    .status-pending{background:var(--pending)}
    .row-actions button{margin-right:8px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .full{grid-column:1/-1}
    .pager{display:flex;gap:8px;align-items:center;margin-top:12px}
    .filter-chips{display:flex;gap:8px;align-items:center}
    .chip{padding:8px 14px;border-radius:999px;background:#fff;border:1px solid #e6eef0;cursor:pointer}
    .chip.active{background:var(--accent);color:#fff}
    .loading{padding:20px;text-align:center;color:var(--muted)}
    footer{margin-top:30px;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:700px){ .form-grid{grid-template-columns:1fr} thead th{font-size:13px} tbody td{font-size:14px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="site">
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24'><path fill='%231f8a56' d='M12 2l3 7h6l-4.5 3.5L20 22l-8-5-8 5 1.5-9.5L1 9h6z'/></svg>" alt="" width="44" height="44">
      <div>
        <h1>PERFECT DIGITAL NETWORK</h1>
        <div style="color:var(--muted);font-size:13px">Pending Payments dashboard</div>
      </div>
    </header>

    <div class="top-stats">
      <div class="stat">Total clients: <strong id="stat-total">—</strong></div>
      <div class="stat">Pending: <strong id="stat-pending">—</strong></div>
      <div class="stat">Paid: <strong id="stat-paid">—</strong></div>
      <div class="stat">Overdue (count): <strong id="stat-overdue">—</strong></div>
    </div>

    <div class="controls">
      <input id="search" class="search" type="text" placeholder="Search client or mobile or address" />
      <div style="min-width:120px">
        <select id="refreshInterval">
          <option value="0">No auto refresh</option>
          <option value="60000">Refresh every 60s</option>
          <option value="120000">120s</option>
        </select>
      </div>
      <div class="filter-chips">
        <div class="chip active" data-area="__all__">All</div>
        <div class="chip" data-area="Wazirpur">Wazirpur</div>
        <div class="chip" data-area="Shastri Nagar">Shastri Nagar</div>
        <div class="chip" data-area="Ashok Vihar">Ashok Vihar</div>
      </div>
      <button class="secondary btn-orange" id="pendingOnly">Pending only</button>
      <button id="reload">Reload now</button>
    </div>

    <div class="table-wrap">
      <table aria-describedby="pending-list">
        <thead>
          <tr>
            <th>Client Name</th>
            <th>Mobile</th>
            <th>Amount (₹)</th>
            <th>Date</th>
            <th>Status</th>
            <th>Address</th>
            <th>Days Pending</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="8" class="loading">Loading...</td></tr>
        </tbody>
      </table>

      <div class="pager">
        <div>Show per page:</div>
        <select id="perPage">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
        </select>
        <button id="prev" class="secondary">Prev</button>
        <button id="next" class="secondary">Next</button>
        <div style="margin-left:auto;color:var(--muted)">Page <span id="pageNum">1</span></div>
      </div>
    </div>

    <section style="margin-top:22px;background:#fff;padding:18px;border-radius:10px">
      <h2>Add new client</h2>
      <form id="addForm">
        <div class="form-grid">
          <div><input id="f_clientname" placeholder="Client name" required /></div>
          <div><input id="f_mobile" placeholder="Mobile" required /></div>
          <div><input id="f_amount" placeholder="Amount (₹)" /></div>
          <div><input id="f_date" placeholder="DD/MM/YYYY or MM/DD/YYYY" /></div>
          <div>
            <select id="f_status">
              <option value="pending">Pending</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div>
            <select id="f_address">
              <option value="">-- choose address --</option>
              <option>Wazirpur</option>
              <option>Shastri Nagar</option>
              <option>Ashok Vihar</option>
            </select>
          </div>
          <div class="full"><input id="f_days_pending" placeholder="Days pending" /></div>
          <div class="full">
            <button type="submit">Add</button>
          </div>
        </div>
      </form>
    </section>

    <footer>Powered by SheetDB • Make sure your SheetDB API URL is set in the script</footer>
  </div>

  <script>
  /* -------------------------
     CONFIG - replace with your SheetDB API
     ------------------------- */
  const API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd'; // <-- REPLACE with your SheetDB API URL

  /* -------------------------
     Helpers
     ------------------------- */
  function normalizeKey(k){
    // lowercase, remove spaces and punctuation and underscores; map to canonical keys
    if(!k) return '';
    const s = k.toString().toLowerCase().replace(/[^a-z0-9]/g,'');
    // common header normalization
    if(s.includes('client') && s.includes('name')) return 'clientname';
    if(s === 'clientname') return 'clientname';
    if(s.includes('mobile') ) return 'mobile';
    if(s.includes('amount')) return 'amount';
    if(s.includes('date')) return 'date';
    if(s.includes('status')) return 'status';
    if(s.includes('address')) return 'address';
    if(s.includes('days') && s.includes('pending')) return 'days_pending';
    // fallback
    return s;
  }

  function normalizeRow(raw){
    // raw is an object with whatever keys SheetDB returned
    const row = {};
    for(const k in raw){
      const nk = normalizeKey(k);
      row[nk] = raw[k];
    }
    // ensure canonical fields exist
    return {
      clientname: row.clientname || '',
      mobile: row.mobile || '',
      amount: row.amount || '',
      date: row.date || '',
      status: (row.status || '').toString().toLowerCase(),
      address: row.address || '',
      days_pending: row.days_pending || row.dayspending || ''
    };
  }

  function htmlEscape(s){ return (s===null||s===undefined)?'':String(s); }

  /* -------------------------
     State
     ------------------------- */
  let rawData = []; // normalized rows
  let filtered = [];
  let page = 1;
  let perPage = parseInt(document.getElementById('perPage').value,10);
  let autoRefreshTimer = null;
  let activeArea = '__all__';
  let showPendingOnly = false;

  /* -------------------------
     Fetch & render
     ------------------------- */
  async function loadData(){
    const tbody = document.getElementById('rows');
    tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading...</td></tr>';
    try{
      const res = await fetch(API);
      if(!res.ok) throw new Error('API error '+res.status);
      const j = await res.json();
      if(!Array.isArray(j)){
        // sometimes sheetdb returns object? try to find data property
        console.warn('unexpected API response', j);
      }
      rawData = j.map(normalizeRow);
      // compute stats
      updateStats();
      applyFiltersAndRender();
    }catch(err){
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="8" class="loading">Error loading data: '+htmlEscape(err.message)+'</td></tr>';
    }
  }

  function updateStats(){
    const total = rawData.length;
    const pending = rawData.filter(r=> (r.status||'').toLowerCase()==='pending').length;
    const paid = rawData.filter(r=> (r.status||'').toLowerCase()==='paid').length;
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-pending').textContent = pending;
    document.getElementById('stat-paid').textContent = paid;
    document.getElementById('stat-overdue').textContent = rawData.filter(r=>parseInt(r.days_pending||0,10)>30).length;
  }

  function applyFiltersAndRender(){
    const q = (document.getElementById('search').value||'').trim().toLowerCase();
    filtered = rawData.filter(r=>{
      if(activeArea !== '__all__' && (r.address||'').toLowerCase() !== activeArea.toLowerCase()) return false;
      if(showPendingOnly && (r.status||'').toLowerCase() !== 'pending') return false;
      if(!q) return true;
      return (r.clientname||'').toLowerCase().includes(q) ||
             (r.mobile||'').toLowerCase().includes(q) ||
             (r.address||'').toLowerCase().includes(q) ||
             (r.remark||'').toLowerCase().includes(q);
    });
    renderPage();
  }

  function renderPage(){
    perPage = parseInt(document.getElementById('perPage').value,10);
    const start = (page-1)*perPage;
    const pageData = filtered.slice(start,start+perPage);
    const tbody = document.getElementById('rows');
    if(pageData.length===0){
      tbody.innerHTML = '<tr><td colspan="8" class="loading">No records</td></tr>';
      document.getElementById('pageNum').textContent = page;
      return;
    }
    const rowsHtml = pageData.map((r, idx)=>{
      const statusClass = (r.status==='paid') ? 'status-paid' : 'status-pending';
      return `<tr>
        <td>${htmlEscape(r.clientname)}</td>
        <td>${htmlEscape(r.mobile)}</td>
        <td>${htmlEscape(r.amount)}</td>
        <td>${htmlEscape(r.date)}</td>
        <td><span class="status-pill ${statusClass}">${htmlEscape(r.status||'')}</span></td>
        <td>${htmlEscape(r.address)}</td>
        <td>${htmlEscape(r.days_pending)}</td>
        <td class="row-actions">
          <button class="secondary" data-action="edit" data-idx="${start+idx}">Edit</button>
          <button class="secondary" data-action="delete" data-idx="${start+idx}">Delete</button>
        </td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rowsHtml;
    document.getElementById('pageNum').textContent = page;
  }

  /* -------------------------
     Add / Edit / Delete
     ------------------------- */
  async function addClient(payload){
    // payload keys should be canonical: clientname, mobile, amount, date, status, address, days_pending
    try{
      const res = await fetch(API, {
        method: 'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ data: payload })
      });
      if(!res.ok) throw new Error('Add failed: '+res.status);
      await res.json();
      await loadData();
      return true;
    }catch(err){
      alert('Add error: '+err.message);
      console.error(err);
      return false;
    }
  }

  async function deleteClientByField(key, value){
    // SheetDB supports DELETE /api/v1/{id}/{column}/{value}
    try{
      const url = `${API}/${encodeURIComponent(key)}/${encodeURIComponent(value)}`;
      const res = await fetch(url, { method:'DELETE' });
      if(!res.ok) throw new Error('Delete failed: '+res.status);
      await res.json();
      await loadData();
    }catch(err){
      alert('Delete error: '+err.message);
      console.error(err);
    }
  }

  async function editClientByField(key, value, patchObj){
    // PATCH /api/v1/{id}/{column}/{value}
    try{
      const url = `${API}/${encodeURIComponent(key)}/${encodeURIComponent(value)}`;
      const res = await fetch(url, {
        method:'PATCH',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ data: patchObj })
      });
      if(!res.ok) throw new Error('Edit failed: '+res.status);
      await res.json();
      await loadData();
    }catch(err){
      alert('Edit error: '+err.message);
      console.error(err);
    }
  }

  /* -------------------------
     Event wiring
     ------------------------- */
  document.getElementById('reload').addEventListener('click', ()=>{ page=1; loadData(); });
  document.getElementById('perPage').addEventListener('change', ()=>{ page=1; renderPage(); });
  document.getElementById('next').addEventListener('click', ()=>{ if((page*perPage) < filtered.length){ page++; renderPage(); }});
  document.getElementById('prev').addEventListener('click', ()=>{ if(page>1){ page--; renderPage(); }});
  document.getElementById('search').addEventListener('input', ()=>{ page=1; applyFiltersAndRender(); });
  document.getElementById('refreshInterval').addEventListener('change', (e)=>{
    if(autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer=null; }
    const v = parseInt(e.target.value,10);
    if(v>0) autoRefreshTimer = setInterval(()=>loadData(), v);
  });

  document.querySelectorAll('.chip').forEach(chip=>{
    chip.addEventListener('click', ()=>{
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      activeArea = chip.dataset.area || '__all__';
      page=1;
      applyFiltersAndRender();
    });
  });

  document.getElementById('pendingOnly').addEventListener('click', (e)=>{
    showPendingOnly = !showPendingOnly;
    e.target.classList.toggle('btn-orange', showPendingOnly);
    page=1; applyFiltersAndRender();
  });

  // row actions (edit/delete) using event delegation
  document.getElementById('rows').addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button');
    if(!btn) return;
    const action = btn.dataset.action;
    const idx = parseInt(btn.dataset.idx,10);
    if(isNaN(idx)) return;
    const row = filtered[idx];
    if(!row) return;
    if(action === 'delete'){
      if(confirm(`Delete client "${row.clientname}"?`)){
        // delete by clientname (works if clientname unique); otherwise adapt to another unique field
        await deleteClientByField('clientname', row.clientname);
      }
      return;
    }
    if(action === 'edit'){
      // show a simple prompt-based edit flow
      const newName = prompt('Client name', row.clientname) || row.clientname;
      const newMobile = prompt('Mobile', row.mobile) || row.mobile;
      const newAmount = prompt('Amount', row.amount) || row.amount;
      const newDate = prompt('Date', row.date) || row.date;
      const newStatus = prompt('Status (pending/paid)', row.status) || row.status;
      const newAddress = prompt('Address', row.address) || row.address;
      const newDays = prompt('Days pending', row.days_pending) || row.days_pending;
      const patch = {
        clientname:newName, mobile:newMobile, amount:newAmount, date:newDate, status:newStatus, address:newAddress, days_pending:newDays
      };
      await editClientByField('clientname', row.clientname, patch);
      return;
    }
  });

  // Add form
  document.getElementById('addForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const payload = {
      clientname: document.getElementById('f_clientname').value.trim(),
      mobile: document.getElementById('f_mobile').value.trim(),
      amount: document.getElementById('f_amount').value.trim(),
      date: document.getElementById('f_date').value.trim(),
      status: document.getElementById('f_status').value,
      address: document.getElementById('f_address').value,
      days_pending: document.getElementById('f_days_pending').value.trim()
    };
    if(!payload.clientname || !payload.mobile){
      alert('Please enter name and mobile.');
      return;
    }
    const ok = await addClient(payload);
    if(ok){
      // clear form
      document.getElementById('addForm').reset();
      page = 1;
    }
  });

  /* -------------------------
     Init
     ------------------------- */
  (function init(){
    loadData();
    // handle click on rows for event delegation is already set
  })();

  </script>
</body>
</html>
