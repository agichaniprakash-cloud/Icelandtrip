<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pending Payments â€” Live from Google Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--accent:#138a5a;--muted:#6b7280;--card:#fff;--bg:#f6f8f9;--radius:12px}
  body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:var(--bg);color:#111827;padding:28px}
  .wrap{max-width:980px;margin:0 auto}
  .card{background:var(--card);border-radius:var(--radius);padding:20px 28px;box-shadow:0 4px 18px rgba(16,24,40,0.06)}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  header h1{font-size:28px;margin:0}
  header p{margin:0;color:var(--muted);font-size:14px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin:16px 0}
  .controls input[type="search"]{flex:1 1 320px;padding:12px 14px;border-radius:10px;border:1px solid #e6e9ee;font-size:14px}
  .btn{background:var(--accent);color:white;padding:10px 16px;border-radius:9px;border:none;cursor:pointer;font-weight:600}
  .btn.small{padding:8px 12px;font-size:14px}
  .select{padding:10px;border-radius:10px;border:1px solid #e6e9ee;background:white;min-width:140px}
  table{width:100%;border-collapse:collapse;margin-top:18px}
  thead th{text-align:left;padding:16px;background:var(--accent);color:white;font-weight:700;font-size:15px}
  tbody tr{background:#fbfcfd}
  td{padding:16px;border-bottom:1px solid #eef2f6;vertical-align:middle}
  .empty{color:var(--muted);text-align:center;padding:28px}
  form .field{margin-top:12px}
  form input, form textarea, form select{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9ee;font-size:15px}
  .tip{color:var(--muted);font-size:13px;margin-top:14px}
  @media (max-width:700px){header{flex-direction:column;align-items:flex-start}.controls{flex-direction:column}thead th{font-size:13px;padding:12px}td{padding:12px}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div style="font-size:30px">ðŸ“‹</div>
      <div>
        <h1>Pending Payments</h1>
        <p>Live from Google Sheet (via SheetDB)</p>
      </div>
    </header>

    <div class="controls">
      <input id="search" type="search" placeholder="Search client, mobile or remark" aria-label="Search">
      <div style="display:flex;gap:10px;align-items:center">
        <select id="refreshInterval" class="select" title="Auto refresh interval">
          <option value="0">Auto refresh: Off</option>
          <option value="15">Refresh every 15s</option>
          <option value="30">Refresh every 30s</option>
          <option value="60" selected>Refresh every 60s</option>
          <option value="300">Refresh every 5m</option>
        </select>
        <button id="pendingOnlyBtn" class="btn small">Show: Pending only</button>
        <button id="reload" class="btn small">Reload now</button>
      </div>
    </div>

    <div id="tableWrap">
      <table id="dataTable" role="table" aria-label="Pending payments table">
        <thead>
          <tr id="theadRow">
            <th>Client Name</th>
            <th>Mobile</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Status</th>
            <th>Remark</th>
            <th>Days Pending</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="empty" colspan="7">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <hr style="margin:22px 0;border:0;border-top:1px solid #eef2f6">

    <h2>Add New Pending Client</h2>

    <form id="addForm">
      <div class="field"><input id="clientname" name="clientname" placeholder="Client Name"></div>
      <div class="field"><input id="mobile" name="mobile" placeholder="Mobile"></div>
      <div class="field"><input id="amount" name="amount" placeholder="Amount"></div>
      <div class="field"><input id="date" name="date" placeholder="Date (e.g. 10/1/2025)"></div>
      <div class="field">
        <select id="status" name="status">
          <option value="pending" selected>Pending</option>
          <option value="paid">Paid</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="field"><input id="remark" name="remark" placeholder="Remark"></div>

      <div style="margin-top:12px">
        <button id="addBtn" class="btn" type="submit">Add</button>
        <span id="formMsg" style="margin-left:12px;color:var(--muted)"></span>
      </div>

      <div class="tip">Tip: Editing the Google Sheet directly (published as CSV) will update this site when refreshed.</div>
    </form>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
/* Replace this with your current SheetDB endpoint if it changes */
const API_URL = 'https://sheetdb.io/api/v1/zla8gcygz4jgd';

/* canonical keys we want inside the app */
const CANONICAL = ['clientname','mobile','amount','date','status','remark','days_pending'];

/* ---------- DOM ---------- */
const tbody = document.getElementById('tbody');
const searchInput = document.getElementById('search');
const reloadBtn = document.getElementById('reload');
const pendingOnlyBtn = document.getElementById('pendingOnlyBtn');
const refreshInterval = document.getElementById('refreshInterval');
const addForm = document.getElementById('addForm');
const formMsg = document.getElementById('formMsg');
const theadRow = document.getElementById('theadRow');

let allData = [];
let mapping = {};        // maps canonical -> actual key from API response
let showPendingOnly = true;
let autoTimer = null;

/* ---------- UTILITIES ---------- */
function normKey(k){
  // normalize: lowercase, remove spaces/underscores, remove non-alphanum
  return String(k||'').toLowerCase().replace(/[\s_]+/g,'').replace(/[^a-z0-9]/g,'');
}
function escapeHtml(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function daysDiffFromToday(dateStr){
  if(!dateStr) return '';
  let d = new Date(dateStr);
  if(isNaN(d)){
    const parts = dateStr.split(/[\/\-\.]/).map(t=>t.trim());
    if(parts.length>=3){
      let mm=+parts[0], dd=+parts[1], yy=+parts[2];
      if(mm>12){ let tmp=mm; mm=dd; dd=tmp; }
      d = new Date(yy, mm-1, dd);
    }
  }
  if(isNaN(d)) return '';
  const today = new Date();
  const diffDays = Math.floor((today - new Date(d.getFullYear(),d.getMonth(),d.getDate()))/(1000*60*60*24));
  return diffDays >= 0 ? String(diffDays) : '';
}

/* flexible mapping: take first object keys and map them to canonical keys */
function buildMapping(firstObj){
  mapping = {};
  const keys = Object.keys(firstObj || {});
  const normMap = {};
  keys.forEach(k => { normMap[normKey(k)] = k; });

  CANONICAL.forEach(can => {
    // try exact normalized match
    const candidate = normMap[normKey(can)] || 
                      normMap['clientname'] && can==='clientname' && (normMap['clientname']) ||
                      null;
    // fallback: if not found try heuristics (e.g. 'clientname' match 'clientname', 'client' etc.)
    if(!candidate){
      // attempt partial matches
      for(const nk in normMap){
        if(nk.includes(normKey(can)) || normKey(can).includes(nk)){
          mapping[can] = normMap[nk];
          break;
        }
      }
    } else {
      mapping[can] = candidate;
    }
  });

  // last resort: if mapping missing, assign first columns in order
  const missing = CANONICAL.filter(c => !mapping[c]);
  let idx=0;
  for(const c of missing){
    // find next key not used
    while(idx<keys.length && Object.values(mapping).includes(keys[idx])) idx++;
    if(idx < keys.length) mapping[c] = keys[idx++];
  }

  // If still missing, leave undefined
  console.log('Field mapping:', mapping);
}

/* get value from an object using mapping */
function getField(obj, canonicalKey){
  const k = mapping[canonicalKey];
  return k ? obj[k] : '';
}

/* ---------- RENDER ---------- */
function renderTableFromJson(json){
  if(!Array.isArray(json)) json = [];
  if(json.length === 0){
    tbody.innerHTML = '<tr><td class="empty" colspan="7">No records</td></tr>';
    return;
  }

  // build mapping from first row
  buildMapping(json[0]);

  // rebuild header labels to show nice names (keep UI consistent)
  // not strictly necessary, but safe to keep standard headers.
  theadRow.innerHTML = `
    <th>Client Name</th>
    <th>Mobile</th>
    <th>Amount</th>
    <th>Date</th>
    <th>Status</th>
    <th>Remark</th>
    <th>Days Pending</th>
  `;

  // build normalized rows array (canonical keys)
  allData = json.map(raw => {
    const row = {};
    CANONICAL.forEach(k => {
      row[k] = getField(raw, k) || '';
    });
    // compute days_pending if blank
    if(!row.days_pending){
      row.days_pending = daysDiffFromToday(row.date);
    }
    return row;
  });

  applyAndRender();
}

function applyAndRender(){
  const q = (searchInput.value || '').trim().toLowerCase();
  let rows = allData.slice();
  if(showPendingOnly) rows = rows.filter(r => (r.status||'').toLowerCase() === 'pending');
  if(q){
    rows = rows.filter(r => CANONICAL.some(k => (r[k]||'').toString().toLowerCase().includes(q)));
  }
  if(rows.length === 0){
    tbody.innerHTML = '<tr><td class="empty" colspan="7">No records</td></tr>';
    return;
  }
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${escapeHtml(r.clientname)}</td>
      <td>${escapeHtml(r.mobile)}</td>
      <td>${escapeHtml(r.amount)}</td>
      <td>${escapeHtml(r.date)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.remark)}</td>
      <td style="text-align:center">${escapeHtml(r.days_pending)}</td>
    </tr>`).join('');
}

/* ---------- NETWORK ---------- */
async function fetchData(){
  try{
    tbody.innerHTML = '<tr><td class="empty" colspan="7">Loadingâ€¦</td></tr>';
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error('Network response not OK: ' + res.status);
    const json = await res.json();
    renderTableFromJson(json);
  }catch(err){
    console.error(err);
    tbody.innerHTML = `<tr><td class="empty" colspan="7">Error loading data â€” ${escapeHtml(err.message || err)}</td></tr>`;
  }
}

/* POST / add row to SheetDB (SheetDB accepts {"data":[{...}]}) */
async function addRowFromForm(fd){
  const obj = {
    clientname: (fd.get('clientname')||'').trim(),
    mobile: (fd.get('mobile')||'').trim(),
    amount: (fd.get('amount')||'').trim(),
    date: (fd.get('date')||'').trim(),
    status: (fd.get('status')||'').trim() || 'pending',
    remark: (fd.get('remark')||'').trim()
  };
  obj.days_pending = daysDiffFromToday(obj.date);

  try{
    formMsg.textContent = 'Sendingâ€¦';
    document.getElementById('addBtn').disabled = true;

    const payload = { data: [obj] };
    const r = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){
      const txt = await r.text();
      throw new Error('Failed to add: ' + (txt || r.statusText));
    }
    formMsg.textContent = 'Added âœ“';
    setTimeout(()=>formMsg.textContent='', 2200);
    addForm.reset();
    await fetchData();
  }catch(err){
    console.error(err);
    formMsg.textContent = 'Error: ' + (err.message || err);
  } finally {
    document.getElementById('addBtn').disabled = false;
  }
}

/* ---------- EVENTS ---------- */
searchInput.addEventListener('input', () => applyAndRender());
reloadBtn.addEventListener('click', fetchData);
pendingOnlyBtn.addEventListener('click', () => {
  showPendingOnly = !showPendingOnly;
  pendingOnlyBtn.textContent = showPendingOnly ? 'Show: Pending only' : 'Show: All';
  applyAndRender();
});
refreshInterval.addEventListener('change', ()=>{
  const val = Number(refreshInterval.value || 0);
  if(autoTimer){ clearInterval(autoTimer); autoTimer = null; }
  if(val>0) autoTimer = setInterval(fetchData, val*1000);
});

addForm.addEventListener('submit', (ev)=>{
  ev.preventDefault();
  const fd = new FormData(addForm);
  if(!fd.get('clientname')) { formMsg.textContent = 'Please enter client name'; return; }
  addRowFromForm(fd);
});

/* initial load */
fetchData();
window._sheetdb = { fetchData, mapping, allData }; // debug
</script>
</body>
</html>
