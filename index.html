<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PERFECT DIGITAL NETWORK â€” Pending Payments</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f4fbf7; --card:#ffffff; --accent:#118a53; --muted:#6b7874;
    --orange:#ff9500; --green:#0ea45f; --danger:#d9534f;
    --radius:12px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#123;min-height:100vh}
  /* fixed header */
  header.appbar{
    position:fixed;left:0;right:0;top:0;height:72px;background:linear-gradient(90deg,#f8fff9,#eef9f3);
    display:flex;align-items:center;gap:18px;padding:12px 20px;border-bottom:1px solid rgba(0,0,0,0.04);z-index:40;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#e9faf0,#d9f2e8);display:flex;align-items:center;justify-content:center;font-size:22px}
  .brand h1{margin:0;font-size:18px;letter-spacing:0.6px;color:var(--accent);text-transform:uppercase}
  .brand .small{font-size:12px;color:var(--muted);margin-top:2px}
  /* body area */
  .container{max-width:1100px;margin:100px auto 60px;padding:16px}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(7,25,16,0.06)}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  input.input, select.select, button.btn{padding:10px 12px;border-radius:10px;border:1px solid #e9f0ec;background:#fff}
  input.input{min-width:220px;flex:1}
  .btn{background:var(--accent);color:#fff;border:0;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #dfeee4;color:var(--muted)}
  .btn.orange{background:var(--orange)}
  .summary{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:12px}
  .summary .item{background:#f8fff9;padding:10px 12px;border-radius:10px;border:1px solid rgba(17,138,83,0.06);min-width:160px}
  .tableWrap{overflow:auto;border-radius:10px}
  table{width:100%;border-collapse:collapse;min-width:860px}
  thead th{background:var(--accent);color:#fff;padding:12px 10px;text-align:left;position:sticky;top:0;z-index:5}
  tbody td{padding:12px 10px;border-bottom:1px solid #f0f6f3;background:#fff}
  tbody tr:nth-child(even) td{background:#fbfdfb}
  .status-pill{padding:6px 8px;border-radius:999px;color:#fff;font-weight:600;display:inline-block;font-size:13px}
  .status-pending{background:var(--orange)}
  .status-paid{background:var(--green)}
  .actions button{margin-right:6px}
  .area-filters{display:flex;gap:8px;flex-wrap:wrap}
  .area-filters button{padding:8px 12px;border-radius:999px;border:1px solid #e6eee8;background:#fff;cursor:pointer}
  .area-filters button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  /* modal */
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(3,8,4,0.35);display:flex;align-items:center;justify-content:center;z-index:80}
  .modal .sheet{background:#fff;padding:18px;border-radius:12px;min-width:320px;max-width:620px}
  .modal .row{display:flex;gap:8px;margin-bottom:8px}
  .modal label{font-size:13px;color:var(--muted);margin-bottom:5px}
  .muted{color:var(--muted)}
  /* toast */
  .toast{position:fixed;right:20px;bottom:18px;padding:10px 12px;border-radius:10px;color:#fff;z-index:110}
  .toast.success{background:var(--green)}
  .toast.error{background:var(--danger)}
  @media (max-width:860px){ .container{margin-top:120px;padding:12px} table{min-width:720px}}
</style>
</head>
<body>

<header class="appbar" role="banner">
  <div class="brand" aria-hidden="true">
    <div class="logo">ðŸ“¡</div>
    <div>
      <h1>PERFECT DIGITAL NETWORK</h1>
      <!-- no tagline as requested -->
    </div>
  </div>

  <!-- quick reload on header -->
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <button id="reloadBtn" class="btn" title="Reload data">Reload</button>
    <button id="addQuickBtn" class="btn ghost" style="margin-left:8px">Add client</button>
  </div>
</header>

<div class="container">
  <div class="card">

    <!-- summary bar -->
    <div class="summary" id="summaryBar" aria-live="polite">
      <div class="item"><div class="muted">Total clients</div><div id="summaryTotal" style="font-weight:700">â€”</div></div>
      <div class="item"><div class="muted">Pending amount (â‚¹)</div><div id="summaryPending" style="font-weight:700">â€”</div></div>
      <div class="item"><div class="muted">Paid amount (â‚¹)</div><div id="summaryPaid" style="font-weight:700">â€”</div></div>
      <div class="item"><div class="muted">Overdue (days)</div><div id="summaryOverdue" style="font-weight:700">â€”</div></div>
    </div>

    <!-- controls -->
    <div class="controls" role="region" aria-label="Controls">
      <input id="searchInput" class="input" placeholder="Search client or mobile or address">
      <div class="area-filters" id="areaFilters">
        <button data-area="all" class="active">All</button>
        <button data-area="Wazirpur">Wazirpur</button>
        <button data-area="Shastri Nagar">Shastri Nagar</button>
        <button data-area="Ashok Vihar">Ashok Vihar</button>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="showPendingBtn" class="btn orange">Pending only</button>
      </div>
    </div>

    <!-- table -->
    <div class="tableWrap" id="tableWrap">
      <table aria-live="polite">
        <thead>
          <tr>
            <th>Client Name</th>
            <th>Mobile</th>
            <th>Amount (â‚¹)</th>
            <th>Date</th>
            <th>Status</th>
            <th>Address</th>
            <th>Days Pending</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="8" class="muted" style="text-align:center;padding:18px">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <!-- add form -->
    <div style="margin-top:14px">
      <h3 style="margin:6px 0 10px">Add new client</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><label class="muted">Client name</label><input id="f_clientname" class="input" /></div>
        <div><label class="muted">Mobile</label><input id="f_mobile" class="input" /></div>
        <div><label class="muted">Amount (â‚¹)</label><input id="f_amount" class="input" /></div>
        <div><label class="muted">Date</label><input id="f_date" class="input" placeholder="DD/MM/YYYY or MM/DD/YYYY" /></div>
        <div><label class="muted">Status</label>
          <select id="f_status" class="select">
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
          </select>
        </div>
        <div><label class="muted">Address</label>
          <select id="f_address" class="select">
            <option value="">-- choose address --</option>
            <option>Wazirpur</option>
            <option>Shastri Nagar</option>
            <option>Ashok Vihar</option>
          </select>
        </div>
        <div style="grid-column:1/-1;margin-top:8px">
          <button id="addBtn" class="btn">Add client</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- edit modal (hidden) -->
<div id="editModal" class="modal" style="display:none" role="dialog" aria-modal="true">
  <div class="sheet">
    <h3>Edit client</h3>
    <div style="margin-top:6px">
      <label class="muted">Client name</label>
      <input id="e_clientname" class="input" />
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label class="muted">Mobile</label>
        <input id="e_mobile" class="input" />
      </div>
      <div style="flex:1">
        <label class="muted">Amount</label>
        <input id="e_amount" class="input" />
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label class="muted">Date</label>
        <input id="e_date" class="input" />
      </div>
      <div style="flex:1">
        <label class="muted">Status</label>
        <select id="e_status" class="select"><option value="pending">Pending</option><option value="paid">Paid</option></select>
      </div>
    </div>
    <div style="margin-top:8px">
      <label class="muted">Address</label>
      <select id="e_address" class="select">
        <option>Wazirpur</option><option>Shastri Nagar</option><option>Ashok Vihar</option>
      </select>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="cancelEdit" class="btn ghost">Cancel</button>
      <button id="saveEdit" class="btn">Save changes</button>
    </div>
  </div>
</div>

<!-- toast root -->
<div id="toastRoot" style="pointer-events:none"></div>

<script>
/*  FINAL app
    - Uses your SheetDB API (replace if different)
    - Admin PIN default: '1234' (change below)
    - Edit/Delete match rows by mobile value (mobile should be unique)
*/

/* === CONFIG === */
const SHEETDB_API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd'; // your endpoint
const ADMIN_PIN = '1234'; // default PIN for testing â€” change this to your preferred PIN

/* === helpers & state === */
const $ = id => document.getElementById(id);
const toastRoot = $('toastRoot');

function showToast(msg, kind='success', t=3000){
  const el = document.createElement('div'); el.className = 'toast ' + (kind==='success' ? 'success' : 'error'); el.textContent = msg;
  el.style.pointerEvents = 'auto';
  toastRoot.appendChild(el);
  setTimeout(()=> el.style.opacity = 0, t-400);
  setTimeout(()=> el.remove(), t);
}

function normalizeKey(s){ return String(s||'').toLowerCase().trim().replace(/\s+/g,' ').replace(/\./g,'').trim(); }
function normalizeMatch(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }

// store rows
let rows = []; // array of raw objects from sheet
let filters = { search:'', address:'all', pendingOnly:false };

/* === fetch data === */
async function loadData(){
  try{
    $('tableBody').innerHTML = '<tr><td colspan="8" class="muted" style="text-align:center;padding:18px">Loadingâ€¦</td></tr>';
    const res = await fetch(SHEETDB_API);
    if(!res.ok) throw new Error('Failed to fetch: ' + res.status);
    const j = await res.json();
    rows = Array.isArray(j) ? j : (j.data || []);
    // compute derived days_pending if missing
    rows = rows.map(r => {
      const copy = Object.assign({}, r);
      copy.__norm = {};
      Object.keys(r).forEach(k => copy.__norm[normalizeKey(k)] = r[k]);
      // compute days_pending if empty or missing
      if(!('days_pending' in copy.__norm) || copy.__norm['days_pending'] === '') {
        const d = parseDateFlexible(copy.__norm['date'] || '');
        if(d) {
          const days = Math.floor((Date.now() - d.getTime())/(1000*60*60*24));
          copy.__norm['days_pending'] = String(Math.max(0, days));
        } else {
          copy.__norm['days_pending'] = '';
        }
      }
      return copy;
    });
    renderAll();
  } catch(err){
    console.error(err);
    $('tableBody').innerHTML = '<tr><td colspan="8" class="muted" style="text-align:center;padding:18px">Error loading data</td></tr>';
    showToast('Error loading data: ' + err.message, 'error', 5000);
  }
}

/* flexible date parser: accepts YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY heuristically */
function parseDateFlexible(s){
  if(!s) return null;
  s = String(s).trim();
  // ISO-like
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s);
  // try slash form
  if(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)){
    const parts = s.split('/');
    // if day>12 treat as DD/MM/YYYY else prefer DD/MM/YYYY because local usage often dd/mm
    let day = parseInt(parts[0],10), month = parseInt(parts[1],10), year = parseInt(parts[2],10);
    if(year<100) year += 2000;
    // assume DD/MM/YYYY first
    if(day > 31 || month > 12) {
      // try swap
      [day,month] = [month,day];
    }
    // JS Date: monthIndex is 0-based
    return new Date(year, month-1, day);
  }
  // try JS parse (fallback)
  const d = new Date(s);
  return isNaN(d.valueOf()) ? null : d;
}

/* === rendering === */
function renderSummary(){
  const total = rows.length;
  let pendingAmt = 0, paidAmt = 0, overdueCount = 0;
  const today = new Date();
  rows.forEach(r => {
    const n = r.__norm;
    const amt = parseFloat((n.amount||'').toString().replace(/[^0-9.-]+/g,'')) || 0;
    const status = (n.status||'').toLowerCase();
    if(status === 'pending') pendingAmt += amt;
    if(status === 'paid') paidAmt += amt;
    // overdue: pending and date older than today
    const d = parseDateFlexible(n.date || '');
    if(status === 'pending' && d && d < today){
      overdueCount++;
    }
  });
  $('summaryTotal').textContent = total;
  $('summaryPending').textContent = Math.round(pendingAmt);
  $('summaryPaid').textContent = Math.round(paidAmt);
  $('summaryOverdue').textContent = overdueCount;
}

function renderTable(){
  const tbody = $('tableBody'); tbody.innerHTML = '';
  const s = filters.search.toLowerCase().trim();
  const addr = filters.address;
  const pendingOnly = filters.pendingOnly;
  // filter rows
  const filtered = rows.filter(r => {
    const n = r.__norm;
    if(addr && addr !== 'all'){
      if(!( (n.address||'').toLowerCase().includes(addr.toLowerCase()) )) return false;
    }
    if(pendingOnly && !( (n.status||'').toLowerCase().includes('pending') )) return false;
    if(s){
      const hay = ((n.clientname||'') + ' ' + (n.mobile||'') + ' ' + (n.address||'')).toLowerCase();
      if(!hay.includes(s)) return false;
    }
    return true;
  });

  if(!filtered.length){
    tbody.innerHTML = '<tr><td colspan="8" class="muted" style="text-align:center;padding:18px">No rows to show</td></tr>';
    return;
  }

  filtered.forEach(row => {
    const n = row.__norm;
    const tr = document.createElement('tr');

    // clientname
    const tdName = document.createElement('td'); tdName.textContent = n.clientname || '';
    tr.appendChild(tdName);
    // mobile
    const tdMobile = document.createElement('td'); tdMobile.textContent = n.mobile || '';
    tr.appendChild(tdMobile);
    // amount
    const tdAmt = document.createElement('td'); tdAmt.textContent = n.amount || '';
    tr.appendChild(tdAmt);
    // date
    const tdDate = document.createElement('td'); tdDate.textContent = n.date || '';
    tr.appendChild(tdDate);
    // status with color
    const tdStatus = document.createElement('td');
    const st = (n.status||'').toLowerCase();
    const pill = document.createElement('span'); pill.className = 'status-pill ' + (st === 'paid' ? 'status-paid' : 'status-pending');
    pill.textContent = (st === 'paid' ? 'Paid' : 'Pending');
    tdStatus.appendChild(pill);
    tr.appendChild(tdStatus);
    // address
    const tdAddr = document.createElement('td'); tdAddr.textContent = n.address || '';
    tr.appendChild(tdAddr);
    // days pending
    const tdDays = document.createElement('td'); tdDays.textContent = n.days_pending || '';
    tr.appendChild(tdDays);
    // actions
    const tdAct = document.createElement('td'); tdAct.className = 'actions';
    const editBtn = document.createElement('button'); editBtn.className = 'btn ghost'; editBtn.textContent = 'Edit';
    editBtn.onclick = () => openEditModal(row);
    const delBtn = document.createElement('button'); delBtn.className = 'btn ghost'; delBtn.textContent = 'Delete';
    delBtn.onclick = () => confirmDelete(row);
    tdAct.appendChild(editBtn); tdAct.appendChild(delBtn);
    tr.appendChild(tdAct);

    tbody.appendChild(tr);
  });
}

function renderAll(){
  renderSummary();
  renderTable();
}

/* === area filter UI === */
document.getElementById('areaFilters').addEventListener('click', (e) => {
  if(e.target.tagName !== 'BUTTON') return;
  const area = e.target.getAttribute('data-area');
  // toggle active
  Array.from(document.querySelectorAll('#areaFilters button')).forEach(b=>b.classList.remove('active'));
  if(area === 'all') {
    e.target.classList.add('active'); filters.address = 'all';
  } else {
    e.target.classList.add('active'); filters.address = area;
  }
  renderAll();
});

/* show pending toggle */
$('showPendingBtn').addEventListener('click', () => {
  filters.pendingOnly = !filters.pendingOnly;
  $('showPendingBtn').textContent = filters.pendingOnly ? 'Showing pending only' : 'Pending only';
  renderAll();
});

/* search */
$('searchInput').addEventListener('input', (e)=> {
  filters.search = e.target.value;
  renderAll();
});

/* reload */
$('reloadBtn').addEventListener('click', loadData);

/* quick add button to focus add form */
$('addQuickBtn').addEventListener('click', () => $('f_clientname').focus());

/* === Add new client === */
$('addBtn').addEventListener('click', async () => {
  const clientname = $('f_clientname').value.trim();
  const mobile = $('f_mobile').value.trim();
  const amount = $('f_amount').value.trim();
  const date = $('f_date').value.trim();
  const status = $('f_status').value;
  const address = $('f_address').value;

  if(!clientname) { showToast('Client name required','error'); return; }
  if(!mobile) { showToast('Mobile required','error'); return; }

  const payload = {
    data: [
      {
        clientname, mobile, amount, date, status, address,
        days_pending: '' // sheet or UI can compute it later
      }
    ]
  };

  try {
    $('addBtn').disabled = true; $('addBtn').textContent = 'Addingâ€¦';
    const res = await fetch(SHEETDB_API, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!res.ok) {
      const txt = await res.text();
      throw new Error(txt || res.status);
    }
    showToast('Added successfully');
    // clear
    ['f_clientname','f_mobile','f_amount','f_date','f_address'].forEach(id => $(id).value = '');
    // reload
    setTimeout(loadData, 800);
  } catch(err){
    console.error(err);
    showToast('Add failed: ' + err.message, 'error', 6000);
  } finally { $('addBtn').disabled = false; $('addBtn').textContent = 'Add client'; }
});

/* === Edit modal === */
let editingRow = null;
function openEditModal(row){
  editingRow = row;
  const n = row.__norm;
  $('e_clientname').value = n.clientname || '';
  $('e_mobile').value = n.mobile || '';
  $('e_amount').value = n.amount || '';
  $('e_date').value = n.date || '';
  $('e_status').value = n.status || 'pending';
  $('e_address').value = n.address || '';
  $('editModal').style.display = 'flex';
}
$('cancelEdit').addEventListener('click', ()=> $('editModal').style.display = 'none');

/* Save edit â€” protected by PIN */
$('saveEdit').addEventListener('click', async () => {
  if(!editingRow) return;
  const oldMobile = (editingRow.__norm.mobile || '').toString().trim();
  const clientname = $('e_clientname').value.trim();
  const mobile = $('e_mobile').value.trim();
  const amount = $('e_amount').value.trim();
  const date = $('e_date').value.trim();
  const status = $('e_status').value;
  const address = $('e_address').value;

  // ask for PIN
  const pin = prompt('Enter admin PIN to save changes');
  if(pin === null) return; // cancelled
  if(pin !== ADMIN_PIN){
    showToast('Incorrect PIN â€” action cancelled','error',3000);
    return;
  }

  // build payload for PATCH (update only these fields)
  const dataObj = { clientname, mobile, amount, date, status, address };
  // Send PATCH to SheetDB to update the row(s) with mobile == oldMobile
  try {
    $('saveEdit').disabled = true; $('saveEdit').textContent = 'Savingâ€¦';
    const patchUrl = SHEETDB_API.replace(/\/+$/,'') + '/mobile/' + encodeURIComponent(oldMobile);
    const res = await fetch(patchUrl, {
      method: 'PATCH',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ data: dataObj })
    });
    if(!res.ok) {
      const txt = await res.text();
      throw new Error(txt || res.status);
    }
    showToast('Updated successfully');
    $('editModal').style.display = 'none';
    setTimeout(loadData, 600);
  } catch(err){
    console.error(err);
    showToast('Update failed: ' + (err.message||'') , 'error', 6000);
  } finally {
    $('saveEdit').disabled = false; $('saveEdit').textContent = 'Save changes';
  }
});

/* === Delete === */
async function confirmDelete(row){
  const n = row.__norm;
  const mobile = (n.mobile||'').toString().trim();
  if(!confirm('Delete client: ' + (n.clientname||'') + ' ? This will remove the row from the sheet.')) return;
  const pin = prompt('Enter admin PIN to delete this row');
  if(pin === null) return;
  if(pin !== ADMIN_PIN){
    showToast('Incorrect PIN â€” delete cancelled','error'); return;
  }
  try {
    const delUrl = SHEETDB_API.replace(/\/+$/,'') + '/mobile/' + encodeURIComponent(mobile);
    const res = await fetch(delUrl, { method: 'DELETE' });
    if(!res.ok) {
      const txt = await res.text();
      throw new Error(txt || res.status);
    }
    showToast('Deleted');
    setTimeout(loadData, 700);
  } catch(err){
    console.error(err);
    showToast('Delete failed: ' + err.message, 'error', 6000);
  }
}

/* initial load */
loadData();

/* small UX: close modal on outside click */
document.getElementById('editModal').addEventListener('click', (e)=> {
  if(e.target.id === 'editModal') $('editModal').style.display = 'none';
});
</script>
</body>
</html>
