<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pending Payments â€” Live</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --green:#13824b;
      --muted:#61707a;
      --card:#ffffff;
      --bg:#f7faf9;
      --glass: rgba(19,130,75,0.08);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:var(--bg);color:#172028;line-height:1.45}
    .wrap{max-width:980px;margin:28px auto;padding:26px;background:linear-gradient(180deg,#fff, #fbffff);box-shadow:0 8px 30px rgba(20,20,20,0.06);border-radius:12px}
    h1{display:flex;align-items:center;gap:12px;font-size:28px;margin:0 0 18px}
    .icon{font-size:28px}
    .sub{color:var(--muted);margin:6px 0 18px}
    .actions{display:flex;gap:12px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
    .search{flex:1;min-width:220px}
    input[type=search], input[type=text], input[type=date], select, textarea{
      width:100%;padding:12px 14px;border-radius:8px;border:1px solid #e6eef0;background:#fff;box-sizing:border-box;
      font-size:15px;color:#1b2b2f;
    }
    .btn{display:inline-block;padding:10px 16px;border-radius:8px;background:var(--green);color:#fff;border:none;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;color:var(--green);border:1px solid rgba(19,130,75,0.12)}
    .controls{display:flex;gap:10px;align-items:center}
    .refresh-select{padding:10px;border-radius:8px;border:1px solid #e6eef0;background:#fff}
    .table-wrap{margin-top:18px;overflow:auto;border-radius:10px;background:#fff;padding:12px;box-shadow:0 8px 20px rgba(18,18,18,0.03)}
    table{width:100%;border-collapse:collapse;font-size:15px}
    thead th{background:var(--green);color:#fff;padding:16px 14px;text-align:left;position:sticky;top:0}
    tbody td{padding:18px 14px;border-bottom:1px solid #f1f5f6}
    .muted{color:var(--muted)}
    .form-section{margin-top:24px;padding-top:20px;border-top:1px solid #eef3f3}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form-grid .full{grid-column:1/-1}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    @media(max-width:720px){
      .form-grid{grid-template-columns:1fr}
      thead th{font-size:14px}
      tbody td{padding:12px}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <h1><span class="icon">ðŸ“‹</span> Pending Payments</h1>
    <div class="sub">Live from Google Sheet (via SheetDB)</div>

    <div class="actions">
      <div class="search">
        <input id="q" type="search" placeholder="Search client, mobile or remark" />
      </div>

      <div class="controls">
        <select id="refreshInterval" class="refresh-select" title="Auto refresh">
          <option value="0">No auto refresh</option>
          <option value="15000">Refresh every 15s</option>
          <option value="30000">Refresh every 30s</option>
          <option value="60000" selected>Refresh every 60s</option>
        </select>

        <button id="showPendingBtn" class="btn secondary">Show: Pending only</button>
        <button id="reloadBtn" class="btn">Reload now</button>
      </div>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="dataTable" aria-live="polite">
        <thead>
          <tr>
            <th>Client Name</th>
            <th>Mobile</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Status</th>
            <th>Remark</th>
            <th>Days Pending</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- content injected -->
        </tbody>
      </table>
    </div>

    <div class="form-section">
      <h2 style="margin:18px 0 12px">Add New Pending Client</h2>

      <div class="form-grid" style="margin-bottom:12px">
        <div class="full"><label for="f_clientname">Client Name</label><input id="f_clientname" type="text" placeholder="Client Name"></div>
        <div><label for="f_mobile">Mobile</label><input id="f_mobile" type="text" placeholder="Mobile"></div>
        <div><label for="f_amount">Amount</label><input id="f_amount" type="text" placeholder="Amount"></div>
        <div><label for="f_date">Date (e.g. 10/1/2025)</label><input id="f_date" type="text" placeholder="10/1/2025"></div>

        <div><label for="f_status">Status</label>
          <select id="f_status">
            <option value="pending" selected>Pending</option>
            <option value="paid">Paid</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div><label for="f_remark">Remark</label><input id="f_remark" type="text" placeholder="Remark"></div>

        <div class="full" style="margin-top:8px">
          <button id="addBtn" class="btn">Add</button>
          <span class="hint">Tip: To update existing rows, edit the Google Sheet directly or use SheetDB's update endpoints.</span>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  FINAL HTML + JS â€” SheetDB integration
  Make sure your Google Sheet headers are exactly:
  clientname  mobile  amount  date  status  remark  days_pending
  (lowercase, underscore for days_pending).
*/

// POINT THIS TO YOUR SHEETDB API endpoint (from sheetdb dashboard)
const SHEETDB_API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd'; // <-- replace if different

let dataCache = [];
let autoTimer = null;
let showPendingOnly = false;

// util: safe get
const $ = id => document.getElementById(id);

async function loadData(){
  try {
    $('reloadBtn').disabled = true;
    $('reloadBtn').textContent = 'Loading...';

    const res = await fetch(SHEETDB_API);
    if (!res.ok) throw new Error('Failed to fetch sheet data');
    const json = await res.json();

    // SheetDB returns array of objects; normalize keys to expected ones
    dataCache = json.map(item => ({
      clientname: (item.clientname || item['Client Name'] || item['Client Name '] || item['Client Name'] || '').toString().trim(),
      mobile: (item.mobile || item.Mobile || item['mobile '] || '').toString().trim(),
      amount: (item.amount || item.Amount || '').toString().trim(),
      date: (item.date || item.Date || '').toString().trim(),
      status: (item.status || '').toString().trim(),
      remark: (item.remark || item.Remark || item.remark || '').toString().trim(),
      days_pending: (item.days_pending || item['days_pending'] || item['Days Pending'] || '').toString().trim()
    }));

    renderTable();
  } catch (err){
    console.error('loadData error', err);
    alert('Error loading data: ' + err.message);
  } finally {
    $('reloadBtn').disabled = false;
    $('reloadBtn').textContent = 'Reload now';
  }
}

function renderTable(){
  const q = $('q').value.trim().toLowerCase();
  const tbody = $('tbody');
  tbody.innerHTML = '';

  const rows = dataCache.filter(r => {
    if (showPendingOnly && r.status.toLowerCase() !== 'pending') return false;
    if (!q) return true;
    return (r.clientname||'').toLowerCase().includes(q)
        || (r.mobile||'').toLowerCase().includes(q)
        || (r.remark||'').toLowerCase().includes(q)
        || (r.status||'').toLowerCase().includes(q);
  });

  if (rows.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 7;
    td.className = 'muted';
    td.textContent = 'No rows found';
    td.style.padding = '18px';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(row => {
    const tr = document.createElement('tr');

    const make = txt => {
      const td = document.createElement('td');
      td.textContent = txt || '';
      return td;
    };

    tr.appendChild(make(row.clientname));
    tr.appendChild(make(row.mobile));
    tr.appendChild(make(row.amount));
    tr.appendChild(make(row.date));
    tr.appendChild(make(row.status));
    tr.appendChild(make(row.remark));
    tr.appendChild(make(row.days_pending));
    tbody.appendChild(tr);
  });
}


// Add form handler â€” IMPORTANT: post uses EXACT keys expected by sheet
$('addBtn').addEventListener('click', async () => {
  const clientname = $('f_clientname').value.trim();
  const mobile = $('f_mobile').value.trim();
  const amount = $('f_amount').value.trim();
  const date = $('f_date').value.trim();
  const status = $('f_status').value;
  const remark = $('f_remark').value.trim();

  if (!clientname) { alert('Please enter Client Name'); return; }

  // Build row object with EXACT header keys as in your sheet
  const row = {
    clientname: clientname,
    mobile: mobile,
    amount: amount,
    date: date,
    status: status,
    remark: remark,
    days_pending: '' // optional; can be computed in sheet if desired
  };

  const payload = { data: [ row ] }; // SheetDB expects { data: [ {...} ] }

  try {
    $('addBtn').disabled = true;
    $('addBtn').textContent = 'Adding...';

    const resp = await fetch(SHEETDB_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok){
      const body = await resp.text();
      throw new Error('SheetDB error: ' + resp.status + ' ' + body);
    }

    // Clear form
    $('f_clientname').value = '';
    $('f_mobile').value = '';
    $('f_amount').value = '';
    $('f_date').value = '';
    $('f_remark').value = '';

    // Wait a moment then reload data (SheetDB sometimes needs a short time)
    setTimeout(() => loadData(), 800);
    alert('Added successfully â€” reload should show it in a second.');
  } catch (err){
    console.error('Add error', err);
    alert('Error adding row: ' + (err.message || err));
  } finally {
    $('addBtn').disabled = false;
    $('addBtn').textContent = 'Add';
  }
});

// UI controls
$('reloadBtn').addEventListener('click', loadData);
$('q').addEventListener('input', renderTable);
$('showPendingBtn').addEventListener('click', () => {
  showPendingOnly = !showPendingOnly;
  $('showPendingBtn').textContent = showPendingOnly ? 'Show: All' : 'Show: Pending only';
  renderTable();
});

// auto refresh
$('refreshInterval').addEventListener('change', () => {
  if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
  const val = Number($('refreshInterval').value);
  if (val > 0) autoTimer = setInterval(loadData, val);
});

// initial load
loadData();
</script>
</body>
</html>
