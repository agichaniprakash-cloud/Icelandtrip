<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pending Payments — Perfect Digital Network</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --green:#138a55;
  --muted:#6b6f72;
  --card:#ffffff;
  --bg:#f6f7f8;
  --accent:#f59e0b;
  --radius:10px;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
body{margin:0;background:var(--bg);color:#1f2933;padding:20px;}
.wrap{max-width:980px;margin:0 auto}
.header{display:flex;align-items:center;gap:18px;margin-bottom:14px}
.logo{width:52px;height:52px;border-radius:10px;background:#eaf6ef;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)}
h1{margin:0;font-size:26px}
.sub{color:var(--muted);font-size:13px}
.card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 8px 20px rgba(9,20,30,0.06)}
.controls{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.controls input[type=search]{width:100%;max-width:520px;padding:12px;border-radius:8px;border:1px solid #e6e9ea}
.btn{background:var(--green);color:white;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid #e6e9ea;color:var(--muted)}
.small{padding:8px 10px;font-size:14px}
.tableWrap{overflow-x:auto;margin-top:8px}
table{border-collapse:collapse;width:100%;min-width:700px}
thead th{background:var(--green);color:#fff;padding:16px 12px;text-align:left}
tbody td{padding:16px 12px;border-bottom:1px solid #f1f2f3;vertical-align:middle}
.status-pending{background:var(--accent);color:#fff;padding:6px 10px;border-radius:20px;display:inline-block}
.status-paid{background:#2dce89;color:#fff;padding:6px 10px;border-radius:20px;display:inline-block}
.actions{display:flex;flex-direction:column;gap:8px}
.actions .small{background:#f3fbf6;border:1px solid #e6efe7;color:var(--green)}
.formRow{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.formRow .row{display:flex;gap:10px;flex-direction:column}
.formRow input,.formRow select{padding:12px;border-radius:8px;border:1px solid #e6e9ea}
.formRow .row input{flex:1}
.notice{font-size:13px;color:var(--muted);margin-top:12px}
.footerControls{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-top:12px}
.pagination{display:flex;align-items:center;gap:8px}
.qr-small{width:36px;height:36px;border-radius:6px;background:#fff;border:1px solid #e6e9ea;display:flex;align-items:center;justify-content:center;cursor:pointer}
.header-stats{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.stat{background:#f0f9f4;padding:8px 12px;border-radius:10px;color:var(--muted)}
@media(min-width:900px){ .formRow .row{flex-direction:row} .controls input[type=search]{width:520px} }
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px">
    <div style="display:flex;align-items:center;gap:14px">
      <div class="logo">PDN</div>
      <div>
        <h1>PERFECT DIGITAL NETWORK</h1>
        <div class="sub">Pending payments dashboard (Live)</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div style="text-align:right;color:var(--muted);font-size:13px">UPI: <strong>perfectdigital@axl</strong></div>
      <!-- QR thumbnail opens modal -->
      <div class="qr-small" id="qrBtn" title="Show UPI QR">QR</div>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <input id="searchBox" type="search" placeholder="Search client, mobile or address" />
      <select id="refreshSel" title="Auto refresh" class="small">
        <option value="0">No Auto-refresh</option>
        <option value="15">15s</option>
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
      </select>
      <button id="filterPendingBtn" class="btn ghost small">Pending only</button>
      <button id="reloadBtn" class="btn small">Reload now</button>
    </div>

    <div class="header-stats">
      <div class="stat" id="statTotal">Total clients: —</div>
      <div class="stat" id="statPendingCount">Pending count: —</div>
      <div class="stat" id="statPendingAmount">Pending amount: —</div>
    </div>

    <div style="margin:10px 0">
      <button class="small" id="areaAll">All</button>
      <button class="small" id="areaWaz">Wazirpur</button>
      <button class="small" id="areaShas">Shas/Trinagar</button>
      <button class="small" id="areaAshok">Ashok Vihar</button>
      <button class="small" id="areaGul">Gulabi Bagh</button>
    </div>

    <div class="tableWrap" id="tableWrap">
      <table id="dataTable" role="table" aria-label="Pending payments table">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="footerControls">
      <div>
        Show per page:
        <select id="perPageSel" class="small">
          <option>10</option>
          <option selected>20</option>
          <option>50</option>
        </select>
      </div>
      <div class="pagination">
        <button id="prevBtn" class="small">Prev</button>
        <div id="pageInd">Page 1</div>
        <button id="nextBtn" class="small">Next</button>
      </div>
    </div>

    <hr style="margin:16px 0;border:none;border-top:1px solid #eee" />

    <h2>Add new client</h2>
    <div class="formRow">
      <div class="row">
        <input id="f_name" placeholder="Client name" />
        <input id="f_mobile" placeholder="Mobile" />
      </div>
      <div class="row">
        <input id="f_amount" placeholder="Amount (₹)" />
        <input id="f_date" placeholder="Date DD/MM/YYYY or MM/DD/YYYY" />
      </div>
      <div class="row">
        <select id="f_status">
          <option>pending</option>
          <option>paid</option>
          <option>other</option>
        </select>
        <select id="f_address">
          <option value="">-- choose address --</option>
          <option>Wazirpur</option>
          <option>Shas/Trinagar</option>
          <option>Ashok Vihar</option>
          <option>Gulabi Bagh</option>
          <option>Other</option>
        </select>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <button id="addBtn" class="btn">Add client</button>
        <div id="msg" style="color:var(--muted)"></div>
      </div>
      <div class="notice">Tip: Publish the sheet (CSV) or add entries from this form.</div>
    </div>
  </div>
</div>

<!-- QR modal -->
<div id="qrModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center">
  <div style="background:#fff;padding:18px;border-radius:12px;max-width:360px;width:90%;text-align:center">
    <h3 style="margin-top:0">UPI — Perfect Digital Network</h3>
    <img id="qrImg" src="qr.png" alt="UPI QR" style="width:260px;height:260px;object-fit:contain" />
    <div style="margin-top:8px">UPI ID: <strong>perfectdigital@axl</strong></div>
    <div style="margin-top:12px"><button id="qrClose" class="small">Close</button></div>
    <div style="font-size:12px;color:var(--muted);margin-top:8px">Replace <code>qr.png</code> with your hosted QR image file (public URL).</div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const SHEETDB_API = 'https://sheetdb.io/api/v1/zla8gcygz4jgd'; // <-- your sheetdb API
const canonical = ["clientname","mobile","amount","date","status","address"]; // remark removed; days removed

/* ---------- UTIL ---------- */
function norm(s){ return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[_\-]+/g,'').replace(/[^a-z0-9]/g,''); }
let headerMap = {};
let lastData = [];
let filterPending = false;
let currentArea = ''; // '' = all
let perPage = 20, pageIndex = 0;

function detectHeaders(data){
  headerMap = {};
  if(data && data.length){
    const keys = Object.keys(data[0]);
    const lookup = {};
    keys.forEach(k => lookup[norm(k)] = k);
    const variants = {
      clientname:['clientname','client','name'],
      mobile:['mobile','phone','mobilenumber','phoneNumber'],
      amount:['amount','amt','price'],
      date:['date','duedate'],
      status:['status','statu'],
      address:['address','area','location','addr']
    };
    Object.keys(variants).forEach(c=>{
      headerMap[c] = keys[0]; // fallback
      for(const v of variants[c]){
        if(lookup[norm(v)]){ headerMap[c]=lookup[norm(v)]; break; }
      }
    });
  } else {
    canonical.forEach(c => headerMap[c]=c);
  }
}

/* ---------- FETCH & RENDER ---------- */
async function fetchData(){
  try{
    const res = await fetch(SHEETDB_API);
    if(!res.ok) throw new Error('Fetch failed: '+res.status);
    const data = await res.json();
    lastData = Array.isArray(data) ? data : [];
    detectHeaders(lastData);
    updateStats(lastData);
    renderTable();
    return lastData;
  } catch(e){
    console.error(e);
    document.getElementById('msg').textContent = 'Error loading data: '+e.message;
    document.getElementById('tableHead').innerHTML = '';
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" style="padding:18px;color:#b91c1c">Error loading data — check API URL and SheetDB settings. See console.</td></tr>';
    return [];
  }
}

function updateStats(data){
  const total = data.length;
  const pendingRows = data.filter(r => String(r[headerMap.status]||'').toLowerCase().includes('pending'));
  const pendingCount = pendingRows.length;
  const pendingAmount = pendingRows.reduce((s,r)=> s + Number((r[headerMap.amount]||'0').toString().replace(/[^0-9.]/g,'')),0);
  document.getElementById('statTotal').textContent = 'Total clients: ' + total;
  document.getElementById('statPendingCount').textContent = 'Pending count: ' + pendingCount;
  document.getElementById('statPendingAmount').textContent = 'Pending amount: ₹' + pendingAmount;
}

function renderTable(){
  const th = document.getElementById('tableHead');
  const tb = document.getElementById('tableBody');
  th.innerHTML=''; tb.innerHTML='';

  const titles = { clientname:'Client Name', mobile:'Mobile', amount:'Amount (₹)', date:'Date', status:'Status', address:'Address', actions:'Actions' };
  const headRow = document.createElement('tr');
  ['clientname','mobile','amount','date','status','address','actions'].forEach(k=>{
    const thc = document.createElement('th');
    thc.textContent = titles[k];
    headRow.appendChild(thc);
  });
  th.appendChild(headRow);

  // filter & paginate
  const search = document.getElementById('searchBox').value.trim().toLowerCase();
  let rows = lastData.slice().filter(r => {
    // area filter
    if(currentArea && String(r[headerMap.address]||'').toLowerCase().indexOf(currentArea.toLowerCase())===-1) return false;
    // pending filter
    if(filterPending && !String(r[headerMap.status]||'').toLowerCase().includes('pending')) return false;
    // search
    if(search){
      const hay = Object.values(r).join(' ').toLowerCase();
      if(hay.indexOf(search)===-1) return false;
    }
    return true;
  });

  // pagination
  const totalPages = Math.max(1, Math.ceil(rows.length / perPage));
  pageIndex = Math.min(pageIndex, totalPages - 1);
  const start = pageIndex * perPage;
  rows = rows.slice(start, start + perPage);
  document.getElementById('pageInd').textContent = `Page ${pageIndex+1}`;

  rows.forEach((row, idx) => {
    const tr = document.createElement('tr');

    // client name
    const tdName = document.createElement('td');
    tdName.textContent = row[headerMap.clientname] || '';
    tr.appendChild(tdName);

    // mobile
    const tdMob = document.createElement('td');
    tdMob.textContent = row[headerMap.mobile] || '';
    tr.appendChild(tdMob);

    // amount
    const tdAmt = document.createElement('td');
    tdAmt.textContent = row[headerMap.amount] || '';
    tr.appendChild(tdAmt);

    // date
    const tdDate = document.createElement('td');
    tdDate.textContent = row[headerMap.date] || '';
    tr.appendChild(tdDate);

    // status with pill
    const tdStatus = document.createElement('td');
    const sText = String(row[headerMap.status]||'').toLowerCase();
    if(sText.includes('paid')) tdStatus.innerHTML = '<span class="status-paid">paid</span>';
    else tdStatus.innerHTML = '<span class="status-pending">pending</span>';
    tr.appendChild(tdStatus);

    // address
    const tdAddr = document.createElement('td');
    tdAddr.textContent = row[headerMap.address] || '';
    tr.appendChild(tdAddr);

    // actions (edit + whatsapp)
    const tdAct = document.createElement('td');
    const div = document.createElement('div');
    div.className='actions';

    // EDIT button (opens prompt to edit name/mobile/amount/status/address/date)
    const btnEdit = document.createElement('button');
    btnEdit.className='small';
    btnEdit.textContent = 'Edit';
    btnEdit.addEventListener('click', ()=>openEditModal(row));
    div.appendChild(btnEdit);

    // WhatsApp send button (only if not paid)
    if(!sText.includes('paid')){
      const btnMsg = document.createElement('button');
      btnMsg.className='small';
      btnMsg.textContent = 'Send msg';
      btnMsg.addEventListener('click', ()=>sendWhatsAppMsg(row));
      div.appendChild(btnMsg);
    }

    tdAct.appendChild(div);
    tr.appendChild(tdAct);

    tb.appendChild(tr);
  });
}

/* ---------- EDIT FLOW (PATCH) ---------- */
function openEditModal(row){
  // simple prompt-based edit (keeps UI compact). You can replace with a nicer modal.
  const fresh = Object.assign({}, row); // copy
  const name = prompt('Edit client name:', fresh[headerMap.clientname]||'');
  if(name===null) return; fresh[headerMap.clientname]=name;
  const mobile = prompt('Edit mobile:', fresh[headerMap.mobile]||'');
  if(mobile===null) return; fresh[headerMap.mobile]=mobile;
  const amount = prompt('Edit amount (₹):', fresh[headerMap.amount]||'');
  if(amount===null) return; fresh[headerMap.amount]=amount;
  const date = prompt('Edit date:', fresh[headerMap.date]||'');
  if(date===null) return; fresh[headerMap.date]=date;
  const status = prompt('Edit status (pending/paid/other):', fresh[headerMap.status]||'pending');
  if(status===null) return; fresh[headerMap.status]=status;
  const addr = prompt('Edit address:', fresh[headerMap.address]||'');
  if(addr===null) return; fresh[headerMap.address]=addr;

  // Build SheetDB PATCH: needs a filter — we'll use the unique row id if present, else attempt to match by all fields (best-effort)
  // SheetDB supports PATCH /api/v1/{id}/{row_id} or search-based. Here we try to use an 'id' if exists.
  const rowIdKey = Object.keys(row).find(k=>k.toLowerCase()==='id' || k.toLowerCase()==='rowid' || k.toLowerCase()==='_row');
  const patchPayload = {};
  patchPayload[ headerMap.clientname ] = fresh[headerMap.clientname];
  patchPayload[ headerMap.mobile ] = fresh[headerMap.mobile];
  patchPayload[ headerMap.amount ] = fresh[headerMap.amount];
  patchPayload[ headerMap.date ] = fresh[headerMap.date];
  patchPayload[ headerMap.status ] = fresh[headerMap.status];
  patchPayload[ headerMap.address ] = fresh[headerMap.address];

  // determine endpoint
  let url = SHEETDB_API;
  let options = {
    method: 'PATCH',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({data: [patchPayload]})
  };

  if(rowIdKey && row[rowIdKey]){
    // safer route: use row id endpoint
    url = SHEETDB_API + '/' + encodeURIComponent(row[rowIdKey]);
  } else {
    // fallback: use filter query by mobile (assuming unique)
    const mobileVal = encodeURIComponent(row[headerMap.mobile]||'');
    url = SHEETDB_API + '/search?mobile=' + mobileVal;
  }

  fetch(url, options).then(r=>r.json()).then(j=>{
    // re-fetch to update UI
    fetchData();
  }).catch(err=>{
    alert('Error updating row: '+err.message);
  });
}

/* ---------- WHATSAPP ---------- */
function sendWhatsAppMsg(row){
  const name = row[headerMap.clientname] || '';
  const mob = String(row[headerMap.mobile]||'').replace(/[^\d+]/g,'');
  const amount = row[headerMap.amount] || '';
  const upi = 'perfectdigital@axl';

  const txt = `Hello ${name || ''}, your broadband payment of ₹${amount || ''} is pending. Please pay to Perfect Digital Network via UPI ID: ${upi}. If already paid, kindly ignore this message.`;
  // use wa.me with phone if mobile present; else open WhatsApp web with message
  if(mob){
    // try to craft wa.me link — mob must be in international format for wa.me; if not, open web.whatsapp with message only
    const phoneDigits = mob.replace(/[^\d]/g,'');
    const waUrl = phoneDigits.length>=8 ? `https://wa.me/${phoneDigits}?text=${encodeURIComponent(txt)}` : `https://web.whatsapp.com/send?text=${encodeURIComponent(txt)}`;
    window.open(waUrl, '_blank');
  } else {
    window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(txt)}`, '_blank');
  }
}

/* ---------- ADD ROW ---------- */
document.getElementById('addBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('f_name').value.trim();
  const mobile = document.getElementById('f_mobile').value.trim();
  const amount = document.getElementById('f_amount').value.trim();
  const date = document.getElementById('f_date').value.trim();
  const status = document.getElementById('f_status').value.trim();
  const address = document.getElementById('f_address').value.trim();

  if(!name && !mobile){ alert('Provide at least name or mobile'); return; }

  // ensure headers
  if(!Object.keys(headerMap).length) await fetchData();

  // payload uses detected header keys
  const obj = {};
  obj[ headerMap.clientname || 'clientname' ] = name;
  obj[ headerMap.mobile || 'mobile' ] = mobile;
  obj[ headerMap.amount || 'amount' ] = amount;
  obj[ headerMap.date || 'date' ] = date;
  obj[ headerMap.status || 'status' ] = status;
  obj[ headerMap.address || 'address' ] = address;

  try{
    const res = await fetch(SHEETDB_API, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({data: [obj]})
    });
    const j = await res.json();
    if(!res.ok) { console.error('Add error', j); alert('Error adding'); return; }
    document.getElementById('msg').textContent = 'Added - reloading...';
    ['f_name','f_mobile','f_amount','f_date','f_days','f_remark'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value='';});
    setTimeout(()=>fetchData().then(()=>document.getElementById('msg').textContent=''),400);
  }catch(e){
    alert('Network error: '+e.message);
  }
});

/* ---------- UI Handlers ---------- */
document.getElementById('reloadBtn').addEventListener('click', ()=>fetchData());
document.getElementById('filterPendingBtn').addEventListener('click', (e)=>{
  filterPending = !filterPending;
  e.target.classList.toggle('btn', filterPending);
  e.target.classList.toggle('ghost', !filterPending);
  renderTable();
});
document.getElementById('searchBox').addEventListener('input', ()=>renderTable());
document.getElementById('perPageSel').addEventListener('change', (e)=>{ perPage = Number(e.target.value); pageIndex=0; renderTable();});
document.getElementById('prevBtn').addEventListener('click', ()=>{ if(pageIndex>0){ pageIndex--; renderTable(); }});
document.getElementById('nextBtn').addEventListener('click', ()=>{ pageIndex++; renderTable();});
document.getElementById('areaAll').addEventListener('click', ()=>{ currentArea=''; pageIndex=0; renderTable();});
document.getElementById('areaWaz').addEventListener('click', ()=>{ currentArea='Wazirpur'; pageIndex=0; renderTable();});
document.getElementById('areaShas').addEventListener('click', ()=>{ currentArea='Shas/Trinagar'; pageIndex=0; renderTable();});
document.getElementById('areaAshok').addEventListener('click', ()=>{ currentArea='Ashok Vihar'; pageIndex=0; renderTable();});
document.getElementById('areaGul').addEventListener('click', ()=>{ currentArea='Gulabi Bagh'; pageIndex=0; renderTable();});

// refresh selector
let refreshTimer = null;
document.getElementById('refreshSel').addEventListener('change',(e)=>{
  const v = Number(e.target.value);
  if(refreshTimer) clearInterval(refreshTimer);
  if(v>0) refreshTimer = setInterval(fetchData, v*1000);
});

// QR modal
document.getElementById('qrBtn').addEventListener('click', ()=>document.getElementById('qrModal').style.display='flex');
document.getElementById('qrClose').addEventListener('click', ()=>document.getElementById('qrModal').style.display='none');

// initial load
fetchData();
</script>
</body>
</html>
